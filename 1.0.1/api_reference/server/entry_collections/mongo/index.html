
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the OPTIMADE Python tools">
      
      
      
        <link rel="canonical" href="https://www.optimade.org/optimade-python-tools/1.0.1/api_reference/server/entry_collections/mongo/">
      
      
        <link rel="prev" href="../entry_collections/">
      
      
        <link rel="next" href="../../mappers/entries/">
      
      
      <link rel="icon" href="../../../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.14">
    
    
      
        <title>mongo - OPTIMADE Python tools</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.fad675c6.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karla:300,300i,400,400i,700,700i%7CShare+Tech+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Karla";--md-code-font:"Share Tech Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../../../css/reference.css">
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="red">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mongo" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="OPTIMADE Python tools" class="md-header__button md-logo" aria-label="OPTIMADE Python tools" data-md-component="logo">
      
  <img src="https://matsci.org/uploads/default/original/2X/b/bd2f59b3bf14fb046b74538750699d7da4c19ac1.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            OPTIMADE Python tools
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              mongo
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="red"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="red"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/Materials-Consortia/optimade-python-tools" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    optimade-python-tools
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="OPTIMADE Python tools" class="md-nav__button md-logo" aria-label="OPTIMADE Python tools" data-md-component="logo">
      
  <img src="https://matsci.org/uploads/default/original/2X/b/bd2f59b3bf14fb046b74538750699d7da4c19ac1.svg" alt="logo">

    </a>
    OPTIMADE Python tools
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Materials-Consortia/optimade-python-tools" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    optimade-python-tools
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../INSTALL/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuration
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Getting started
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Getting started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../getting_started/client/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using the OPTIMADE client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../getting_started/setting_up_an_api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Setting up an OPTIMADE API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../getting_started/use_cases/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Example use cases
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Deployment
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Deployment
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../deployment/integrated/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Integrate OPTIMADE with an existing web application
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../deployment/container/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Run in a container (Docker)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Concepts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../concepts/validation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Validation of OPTIMADE APIs
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../concepts/filtering/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Filter parsing and transforming
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../CONTRIBUTING/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing and getting help
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../CHANGELOG/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Changelog
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../all_models/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OPTIMADE Data Models
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exceptions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../warnings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    warnings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_4" >
        
          
          <label class="md-nav__link" for="__nav_10_4" id="__nav_10_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    adapters
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_4">
            <span class="md-nav__icon md-icon"></span>
            adapters
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/base/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    base
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exceptions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/logger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/warnings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    warnings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_4_5" >
        
          
          <label class="md-nav__link" for="__nav_10_4_5" id="__nav_10_4_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    references
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_10_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_4_5">
            <span class="md-nav__icon md-icon"></span>
            references
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/references/adapter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    adapter
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_4_6" >
        
          
          <label class="md-nav__link" for="__nav_10_4_6" id="__nav_10_4_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    structures
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_10_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_4_6">
            <span class="md-nav__icon md-icon"></span>
            structures
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/structures/adapter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    adapter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/structures/aiida/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    aiida
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/structures/ase/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ase
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/structures/cif/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cif
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/structures/jarvis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    jarvis
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/structures/proteindatabank/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    proteindatabank
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/structures/pymatgen/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    pymatgen
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../adapters/structures/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_5" >
        
          
          <label class="md-nav__link" for="__nav_10_5" id="__nav_10_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    client
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_5">
            <span class="md-nav__icon md-icon"></span>
            client
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../client/cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    cli
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../client/client/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../client/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_6" >
        
          
          <label class="md-nav__link" for="__nav_10_6" id="__nav_10_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    filterparser
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_6">
            <span class="md-nav__icon md-icon"></span>
            filterparser
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../filterparser/lark_parser/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    lark_parser
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_7" >
        
          
          <label class="md-nav__link" for="__nav_10_7" id="__nav_10_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    filtertransformers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_7">
            <span class="md-nav__icon md-icon"></span>
            filtertransformers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../filtertransformers/base_transformer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    base_transformer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../filtertransformers/elasticsearch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    elasticsearch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../filtertransformers/mongo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mongo
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_8" >
        
          
          <label class="md-nav__link" for="__nav_10_8" id="__nav_10_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    models
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_8">
            <span class="md-nav__icon md-icon"></span>
            models
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/baseinfo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    baseinfo
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/entries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    entries
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/index_metadb/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    index_metadb
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/jsonapi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    jsonapi
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/links/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    links
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/optimade_json/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    optimade_json
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/references/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    references
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/responses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    responses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/structures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    structures
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/types/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    types
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../models/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_9" checked>
        
          
          <label class="md-nav__link" for="__nav_10_9" id="__nav_10_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    server
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_9_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10_9">
            <span class="md-nav__icon md-icon"></span>
            server
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../exception_handlers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exception_handlers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../exceptions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    exceptions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../logger/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    logger
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../main/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    main
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../main_index/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    main_index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../middleware/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    middleware
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../query_params/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    query_params
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../schemas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    schemas
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../warnings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    warnings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_9_11" checked>
        
          
          <label class="md-nav__link" for="__nav_10_9_11" id="__nav_10_9_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    entry_collections
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_10_9_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10_9_11">
            <span class="md-nav__icon md-icon"></span>
            entry_collections
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../elasticsearch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    elasticsearch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../entry_collections/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    entry_collections
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    mongo
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    mongo
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo" class="md-nav__link">
    <span class="md-ellipsis">
      mongo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.CLIENT" class="md-nav__link">
    <span class="md-ellipsis">
      CLIENT
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.CONFIG" class="md-nav__link">
    <span class="md-ellipsis">
      CONFIG
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.LOGGER" class="md-nav__link">
    <span class="md-ellipsis">
      LOGGER
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper" class="md-nav__link">
    <span class="md-ellipsis">
      BaseResourceMapper
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseResourceMapper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.ALL_ATTRIBUTES" class="md-nav__link">
    <span class="md-ellipsis">
      ALL_ATTRIBUTES()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.ENDPOINT" class="md-nav__link">
    <span class="md-ellipsis">
      ENDPOINT()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.ENTRY_RESOURCE_ATTRIBUTES" class="md-nav__link">
    <span class="md-ellipsis">
      ENTRY_RESOURCE_ATTRIBUTES()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.SUPPORTED_PREFIXES" class="md-nav__link">
    <span class="md-ellipsis">
      SUPPORTED_PREFIXES()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.alias_for" class="md-nav__link">
    <span class="md-ellipsis">
      alias_for()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.alias_of" class="md-nav__link">
    <span class="md-ellipsis">
      alias_of()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.all_aliases" class="md-nav__link">
    <span class="md-ellipsis">
      all_aliases()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.all_length_aliases" class="md-nav__link">
    <span class="md-ellipsis">
      all_length_aliases()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.deserialize" class="md-nav__link">
    <span class="md-ellipsis">
      deserialize()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.get_backend_field" class="md-nav__link">
    <span class="md-ellipsis">
      get_backend_field()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.get_optimade_field" class="md-nav__link">
    <span class="md-ellipsis">
      get_optimade_field()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.get_required_fields" class="md-nav__link">
    <span class="md-ellipsis">
      get_required_fields()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.length_alias_for" class="md-nav__link">
    <span class="md-ellipsis">
      length_alias_for()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.map_back" class="md-nav__link">
    <span class="md-ellipsis">
      map_back()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection" class="md-nav__link">
    <span class="md-ellipsis">
      EntryCollection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EntryCollection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.all_fields" class="md-nav__link">
    <span class="md-ellipsis">
      all_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.pagination_mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      pagination_mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.count" class="md-nav__link">
    <span class="md-ellipsis">
      count()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.find" class="md-nav__link">
    <span class="md-ellipsis">
      find()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.get_attribute_fields" class="md-nav__link">
    <span class="md-ellipsis">
      get_attribute_fields()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.get_next_query_params" class="md-nav__link">
    <span class="md-ellipsis">
      get_next_query_params()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.handle_query_params" class="md-nav__link">
    <span class="md-ellipsis">
      handle_query_params()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.insert" class="md-nav__link">
    <span class="md-ellipsis">
      insert()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.parse_sort_params" class="md-nav__link">
    <span class="md-ellipsis">
      parse_sort_params()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryListingQueryParams" class="md-nav__link">
    <span class="md-ellipsis">
      EntryListingQueryParams
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EntryListingQueryParams">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryListingQueryParams.check_params" class="md-nav__link">
    <span class="md-ellipsis">
      check_params()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryResource" class="md-nav__link">
    <span class="md-ellipsis">
      EntryResource
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection" class="md-nav__link">
    <span class="md-ellipsis">
      MongoCollection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MongoCollection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.all_fields" class="md-nav__link">
    <span class="md-ellipsis">
      all_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.pagination_mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      pagination_mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.count" class="md-nav__link">
    <span class="md-ellipsis">
      count()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.find" class="md-nav__link">
    <span class="md-ellipsis">
      find()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.get_attribute_fields" class="md-nav__link">
    <span class="md-ellipsis">
      get_attribute_fields()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.get_next_query_params" class="md-nav__link">
    <span class="md-ellipsis">
      get_next_query_params()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.handle_query_params" class="md-nav__link">
    <span class="md-ellipsis">
      handle_query_params()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.insert" class="md-nav__link">
    <span class="md-ellipsis">
      insert()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.parse_sort_params" class="md-nav__link">
    <span class="md-ellipsis">
      parse_sort_params()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer" class="md-nav__link">
    <span class="md-ellipsis">
      MongoTransformer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MongoTransformer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.backend_mapping" class="md-nav__link">
    <span class="md-ellipsis">
      backend_mapping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.quantities" class="md-nav__link">
    <span class="md-ellipsis">
      quantities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.__default__" class="md-nav__link">
    <span class="md-ellipsis">
      __default__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.comparison" class="md-nav__link">
    <span class="md-ellipsis">
      comparison()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.constant" class="md-nav__link">
    <span class="md-ellipsis">
      constant()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.filter" class="md-nav__link">
    <span class="md-ellipsis">
      filter()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.non_string_value" class="md-nav__link">
    <span class="md-ellipsis">
      non_string_value()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.not_implemented_string" class="md-nav__link">
    <span class="md-ellipsis">
      not_implemented_string()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.number" class="md-nav__link">
    <span class="md-ellipsis">
      number()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.postprocess" class="md-nav__link">
    <span class="md-ellipsis">
      postprocess()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.signed_int" class="md-nav__link">
    <span class="md-ellipsis">
      signed_int()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.string" class="md-nav__link">
    <span class="md-ellipsis">
      string()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.transform" class="md-nav__link">
    <span class="md-ellipsis">
      transform()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.value" class="md-nav__link">
    <span class="md-ellipsis">
      value()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.SingleEntryQueryParams" class="md-nav__link">
    <span class="md-ellipsis">
      SingleEntryQueryParams
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SingleEntryQueryParams">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.SingleEntryQueryParams.check_params" class="md-nav__link">
    <span class="md-ellipsis">
      check_params()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.SupportedBackend" class="md-nav__link">
    <span class="md-ellipsis">
      SupportedBackend
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_9_12" >
        
          
          <label class="md-nav__link" for="__nav_10_9_12" id="__nav_10_9_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    mappers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_10_9_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_9_12">
            <span class="md-nav__icon md-icon"></span>
            mappers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mappers/entries/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    entries
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mappers/links/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    links
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mappers/references/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    references
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../mappers/structures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    structures
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_9_13" >
        
          
          <label class="md-nav__link" for="__nav_10_9_13" id="__nav_10_9_13_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    routers
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_10_9_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_9_13">
            <span class="md-nav__icon md-icon"></span>
            routers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../routers/index_info/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    index_info
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../routers/info/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    info
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../routers/landing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    landing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../routers/links/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    links
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../routers/references/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    references
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../routers/structures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    structures
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../routers/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../routers/versions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    versions
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10_10" >
        
          
          <label class="md-nav__link" for="__nav_10_10" id="__nav_10_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    validator
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_10">
            <span class="md-nav__icon md-icon"></span>
            validator
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../validator/config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    config
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../validator/utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../validator/validator/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    validator
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo" class="md-nav__link">
    <span class="md-ellipsis">
      mongo
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.CLIENT" class="md-nav__link">
    <span class="md-ellipsis">
      CLIENT
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.CONFIG" class="md-nav__link">
    <span class="md-ellipsis">
      CONFIG
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.LOGGER" class="md-nav__link">
    <span class="md-ellipsis">
      LOGGER
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper" class="md-nav__link">
    <span class="md-ellipsis">
      BaseResourceMapper
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseResourceMapper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.ALL_ATTRIBUTES" class="md-nav__link">
    <span class="md-ellipsis">
      ALL_ATTRIBUTES()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.ENDPOINT" class="md-nav__link">
    <span class="md-ellipsis">
      ENDPOINT()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.ENTRY_RESOURCE_ATTRIBUTES" class="md-nav__link">
    <span class="md-ellipsis">
      ENTRY_RESOURCE_ATTRIBUTES()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.SUPPORTED_PREFIXES" class="md-nav__link">
    <span class="md-ellipsis">
      SUPPORTED_PREFIXES()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.alias_for" class="md-nav__link">
    <span class="md-ellipsis">
      alias_for()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.alias_of" class="md-nav__link">
    <span class="md-ellipsis">
      alias_of()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.all_aliases" class="md-nav__link">
    <span class="md-ellipsis">
      all_aliases()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.all_length_aliases" class="md-nav__link">
    <span class="md-ellipsis">
      all_length_aliases()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.deserialize" class="md-nav__link">
    <span class="md-ellipsis">
      deserialize()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.get_backend_field" class="md-nav__link">
    <span class="md-ellipsis">
      get_backend_field()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.get_optimade_field" class="md-nav__link">
    <span class="md-ellipsis">
      get_optimade_field()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.get_required_fields" class="md-nav__link">
    <span class="md-ellipsis">
      get_required_fields()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.length_alias_for" class="md-nav__link">
    <span class="md-ellipsis">
      length_alias_for()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.map_back" class="md-nav__link">
    <span class="md-ellipsis">
      map_back()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection" class="md-nav__link">
    <span class="md-ellipsis">
      EntryCollection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EntryCollection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.all_fields" class="md-nav__link">
    <span class="md-ellipsis">
      all_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.pagination_mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      pagination_mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.count" class="md-nav__link">
    <span class="md-ellipsis">
      count()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.find" class="md-nav__link">
    <span class="md-ellipsis">
      find()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.get_attribute_fields" class="md-nav__link">
    <span class="md-ellipsis">
      get_attribute_fields()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.get_next_query_params" class="md-nav__link">
    <span class="md-ellipsis">
      get_next_query_params()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.handle_query_params" class="md-nav__link">
    <span class="md-ellipsis">
      handle_query_params()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.insert" class="md-nav__link">
    <span class="md-ellipsis">
      insert()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryCollection.parse_sort_params" class="md-nav__link">
    <span class="md-ellipsis">
      parse_sort_params()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryListingQueryParams" class="md-nav__link">
    <span class="md-ellipsis">
      EntryListingQueryParams
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EntryListingQueryParams">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryListingQueryParams.check_params" class="md-nav__link">
    <span class="md-ellipsis">
      check_params()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.EntryResource" class="md-nav__link">
    <span class="md-ellipsis">
      EntryResource
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection" class="md-nav__link">
    <span class="md-ellipsis">
      MongoCollection
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MongoCollection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.all_fields" class="md-nav__link">
    <span class="md-ellipsis">
      all_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.pagination_mechanism" class="md-nav__link">
    <span class="md-ellipsis">
      pagination_mechanism
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.__len__" class="md-nav__link">
    <span class="md-ellipsis">
      __len__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.count" class="md-nav__link">
    <span class="md-ellipsis">
      count()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.find" class="md-nav__link">
    <span class="md-ellipsis">
      find()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.get_attribute_fields" class="md-nav__link">
    <span class="md-ellipsis">
      get_attribute_fields()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.get_next_query_params" class="md-nav__link">
    <span class="md-ellipsis">
      get_next_query_params()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.handle_query_params" class="md-nav__link">
    <span class="md-ellipsis">
      handle_query_params()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.insert" class="md-nav__link">
    <span class="md-ellipsis">
      insert()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoCollection.parse_sort_params" class="md-nav__link">
    <span class="md-ellipsis">
      parse_sort_params()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer" class="md-nav__link">
    <span class="md-ellipsis">
      MongoTransformer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MongoTransformer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.backend_mapping" class="md-nav__link">
    <span class="md-ellipsis">
      backend_mapping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.quantities" class="md-nav__link">
    <span class="md-ellipsis">
      quantities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.__default__" class="md-nav__link">
    <span class="md-ellipsis">
      __default__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.comparison" class="md-nav__link">
    <span class="md-ellipsis">
      comparison()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.constant" class="md-nav__link">
    <span class="md-ellipsis">
      constant()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.filter" class="md-nav__link">
    <span class="md-ellipsis">
      filter()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.non_string_value" class="md-nav__link">
    <span class="md-ellipsis">
      non_string_value()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.not_implemented_string" class="md-nav__link">
    <span class="md-ellipsis">
      not_implemented_string()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.number" class="md-nav__link">
    <span class="md-ellipsis">
      number()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.postprocess" class="md-nav__link">
    <span class="md-ellipsis">
      postprocess()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.signed_int" class="md-nav__link">
    <span class="md-ellipsis">
      signed_int()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.string" class="md-nav__link">
    <span class="md-ellipsis">
      string()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.transform" class="md-nav__link">
    <span class="md-ellipsis">
      transform()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.MongoTransformer.value" class="md-nav__link">
    <span class="md-ellipsis">
      value()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.SingleEntryQueryParams" class="md-nav__link">
    <span class="md-ellipsis">
      SingleEntryQueryParams
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SingleEntryQueryParams">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.SingleEntryQueryParams.check_params" class="md-nav__link">
    <span class="md-ellipsis">
      check_params()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#optimade.server.entry_collections.mongo.SupportedBackend" class="md-nav__link">
    <span class="md-ellipsis">
      SupportedBackend
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="mongo">mongo<a class="headerlink" href="#mongo" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<a id="optimade.server.entry_collections.mongo"></a>
  <div class="doc doc-contents first">

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h2 id="optimade.server.entry_collections.mongo.CLIENT" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">CLIENT</span> <span class="o">=</span> <span class="n">MongoClient</span><span class="p">(</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">mongo_uri</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.CLIENT" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h2 id="optimade.server.entry_collections.mongo.CONFIG" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">CONFIG</span><span class="p">:</span> <span class="n">ServerConfig</span> <span class="o">=</span> <span class="n">ServerConfig</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.CONFIG" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  
      <p>This singleton loads the config from a hierarchy of sources (see
<a class="autorefs autorefs-internal" href="../../config/#optimade.server.config.ServerConfig.settings_customise_sources"><code>customise_sources</code></a>)
and makes it importable in the server code.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h2 id="optimade.server.entry_collections.mongo.LOGGER" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;optimade&#39;</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.LOGGER" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
  </div>

</div>


<div class="doc doc-object doc-class">




<h2 id="optimade.server.entry_collections.mongo.BaseResourceMapper" class="doc doc-heading">
          <code>BaseResourceMapper</code>


<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">

  
      <p>Generic Resource Mapper that defines and performs the mapping
between objects in the database and the resource objects defined by
the specification.</p>



  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>ALIASES</code></td>
          <td>
                <code>tuple[tuple[str, str], ...]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a tuple of aliases between
OPTIMADE field names and the field names in the database ,
e.g. <code>(("elements", "custom_elements_field"))</code>.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>LENGTH_ALIASES</code></td>
          <td>
                <code>tuple[tuple[str, str], ...]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a tuple of aliases between
a field name and another field that defines its length, to be used
when querying, e.g. <code>(("elements", "nelements"))</code>.
e.g. <code>(("elements", "custom_elements_field"))</code>.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>ENTRY_RESOURCE_CLASS</code></td>
          <td>
                <code>type[<a class="autorefs autorefs-internal" title="optimade.models.entries.EntryResource" href="../../../models/entries/#optimade.models.entries.EntryResource">EntryResource</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The entry type that this mapper corresponds to.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>PROVIDER_FIELDS</code></td>
          <td>
                <code>tuple[str, ...]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>a tuple of extra field names that this
mapper should support when querying with the database prefix.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>TOP_LEVEL_NON_ATTRIBUTES_FIELDS</code></td>
          <td>
                <code>set[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>the set of top-level
field names common to all endpoints.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>SUPPORTED_PREFIXES</code></td>
          <td>
                <code>set[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The set of prefixes registered by this mapper.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>ALL_ATTRIBUTES</code></td>
          <td>
                <code>set[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The set of attributes defined across the entry
resource class and the server configuration.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>ENTRY_RESOURCE_ATTRIBUTES</code></td>
          <td>
                <code>dict[str, <span title="typing.Any">Any</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary of attributes and their definitions
defined by the schema of the entry resource class.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>ENDPOINT</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The expected endpoint name for this resource, as defined by
the <code>type</code> in the schema of the entry resource class.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

            <details class="quote">
              <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">BaseResourceMapper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generic Resource Mapper that defines and performs the mapping</span>
<span class="sd">    between objects in the database and the resource objects defined by</span>
<span class="sd">    the specification.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ALIASES: a tuple of aliases between</span>
<span class="sd">            OPTIMADE field names and the field names in the database ,</span>
<span class="sd">            e.g. `((&quot;elements&quot;, &quot;custom_elements_field&quot;))`.</span>
<span class="sd">        LENGTH_ALIASES: a tuple of aliases between</span>
<span class="sd">            a field name and another field that defines its length, to be used</span>
<span class="sd">            when querying, e.g. `((&quot;elements&quot;, &quot;nelements&quot;))`.</span>
<span class="sd">            e.g. `((&quot;elements&quot;, &quot;custom_elements_field&quot;))`.</span>
<span class="sd">        ENTRY_RESOURCE_CLASS: The entry type that this mapper corresponds to.</span>
<span class="sd">        PROVIDER_FIELDS: a tuple of extra field names that this</span>
<span class="sd">            mapper should support when querying with the database prefix.</span>
<span class="sd">        TOP_LEVEL_NON_ATTRIBUTES_FIELDS: the set of top-level</span>
<span class="sd">            field names common to all endpoints.</span>
<span class="sd">        SUPPORTED_PREFIXES: The set of prefixes registered by this mapper.</span>
<span class="sd">        ALL_ATTRIBUTES: The set of attributes defined across the entry</span>
<span class="sd">            resource class and the server configuration.</span>
<span class="sd">        ENTRY_RESOURCE_ATTRIBUTES: A dictionary of attributes and their definitions</span>
<span class="sd">            defined by the schema of the entry resource class.</span>
<span class="sd">        ENDPOINT: The expected endpoint name for this resource, as defined by</span>
<span class="sd">            the `type` in the schema of the entry resource class.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">optimade.server.data</span> <span class="kn">import</span> <span class="n">providers</span> <span class="k">as</span> <span class="n">PROVIDERS</span>  <span class="c1"># type: ignore</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ImportError</span><span class="p">,</span> <span class="ne">ModuleNotFoundError</span><span class="p">):</span>
        <span class="n">PROVIDERS</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">KNOWN_PROVIDER_PREFIXES</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">prov</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">prov</span> <span class="ow">in</span> <span class="n">PROVIDERS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="p">}</span>
    <span class="n">ALIASES</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">LENGTH_ALIASES</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">PROVIDER_FIELDS</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">ENTRY_RESOURCE_CLASS</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">]</span> <span class="o">=</span> <span class="n">EntryResource</span>
    <span class="n">RELATIONSHIP_ENTRY_TYPES</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;references&quot;</span><span class="p">,</span> <span class="s2">&quot;structures&quot;</span><span class="p">}</span>
    <span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;relationships&quot;</span><span class="p">,</span> <span class="s2">&quot;links&quot;</span><span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">NUM_ENTRY_TYPES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">all_aliases</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all of the associated aliases for this entry type,</span>
<span class="sd">        including those defined by the server config. The first member</span>
<span class="sd">        of each tuple is the OPTIMADE-compliant field name, the second</span>
<span class="sd">        is the backend-specific field name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple of alias tuples.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">optimade.server.config</span> <span class="kn">import</span> <span class="n">CONFIG</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span>
                <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">PROVIDER_FIELDS</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ALIASES</span>
        <span class="p">)</span>

    <span class="nd">@classproperty</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">SUPPORTED_PREFIXES</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A set of prefixes handled by this entry type.</span>

<span class="sd">        !!! note</span>
<span class="sd">            This implementation only includes the provider prefix,</span>
<span class="sd">            but in the future this property may be extended to include other</span>
<span class="sd">            namespaces (for serving fields from, e.g., other providers or</span>
<span class="sd">            domain-specific terms).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">optimade.server.config</span> <span class="kn">import</span> <span class="n">CONFIG</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">prefix</span><span class="p">}</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">ALL_ATTRIBUTES</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all attributes served by this entry.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">optimade.server.config</span> <span class="kn">import</span> <span class="n">CONFIG</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENTRY_RESOURCE_ATTRIBUTES</span><span class="p">)</span>
            <span class="o">.</span><span class="n">union</span><span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">())</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">union</span><span class="p">(</span>
                <span class="bp">cls</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">())</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">PROVIDER_FIELDS</span><span class="p">})</span>
        <span class="p">)</span>

    <span class="nd">@classproperty</span>
    <span class="k">def</span> <span class="nf">ENTRY_RESOURCE_ATTRIBUTES</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the dictionary of attributes defined by the underlying entry resource class.&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">optimade.server.schemas</span> <span class="kn">import</span> <span class="n">retrieve_queryable_properties</span>

        <span class="k">return</span> <span class="n">retrieve_queryable_properties</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENTRY_RESOURCE_CLASS</span><span class="p">)</span>

    <span class="nd">@classproperty</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">NUM_ENTRY_TYPES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ENDPOINT</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the expected endpoint for this mapper, corresponding</span>
<span class="sd">        to the `type` property of the resource class.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ENTRY_RESOURCE_CLASS</span><span class="o">.</span><span class="n">model_fields</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">endpoint</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Type not set for this entry type!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">endpoint</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">NUM_ENTRY_TYPES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">all_length_aliases</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns all of the associated length aliases for this class,</span>
<span class="sd">        including those defined by the server config.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple of length alias tuples.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">optimade.server.config</span> <span class="kn">import</span> <span class="n">CONFIG</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LENGTH_ALIASES</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="n">CONFIG</span><span class="o">.</span><span class="n">length_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">length_alias_for</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the length alias for the particular field,</span>
<span class="sd">        or `None` if no such alias is found.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            field: OPTIMADE field name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Aliased field as found in [`all_length_aliases()`][optimade.server.mappers.entries.BaseResourceMapper.all_length_aliases].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">all_length_aliases</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_backend_field</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">optimade_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the field name configured for the particular</span>
<span class="sd">        underlying database for the passed OPTIMADE field name, that would</span>
<span class="sd">        be used in an API filter.</span>

<span class="sd">        Aliases are read from</span>
<span class="sd">        [`all_aliases()`][optimade.server.mappers.entries.BaseResourceMapper.all_aliases].</span>

<span class="sd">        If a dot-separated OPTIMADE field is provided, e.g., `species.mass`, only the first part will be mapped.</span>
<span class="sd">        This means for an (OPTIMADE, DB) alias of (`species`, `kinds`), `get_backend_fields(&quot;species.mass&quot;)`</span>
<span class="sd">        will return `kinds.mass`.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            optimade_field: The OPTIMADE field to attempt to map to the backend-specific field.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; get_backend_field(&quot;chemical_formula_anonymous&quot;)</span>
<span class="sd">            &#39;formula_anon&#39;</span>
<span class="sd">            &gt;&gt;&gt; get_backend_field(&quot;formula_anon&quot;)</span>
<span class="sd">            &#39;formula_anon&#39;</span>
<span class="sd">            &gt;&gt;&gt; get_backend_field(&quot;_exmpl_custom_provider_field&quot;)</span>
<span class="sd">            &#39;custom_provider_field&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            The mapped field name to be used in the query to the backend.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">split</span> <span class="o">=</span> <span class="n">optimade_field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">all_aliases</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">alias</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">optimade_field</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">alias_for</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return aliased field name.</span>

<span class="sd">        !!! warning &quot;Deprecated&quot;</span>
<span class="sd">            This method is deprecated could be removed without further warning. Please use</span>
<span class="sd">            [`get_backend_field()`][optimade.server.mappers.entries.BaseResourceMapper.get_backend_field].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            field: OPTIMADE field name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Aliased field as found in [`all_aliases()`][optimade.server.mappers.entries.BaseResourceMapper.all_aliases].</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The `.alias_for(...)` method is deprecated, please use `.get_backend_field(...)`.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_backend_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_optimade_field</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">backend_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the corresponding OPTIMADE field name for the underlying database field,</span>
<span class="sd">        ready to be used to construct the OPTIMADE-compliant JSON response.</span>

<span class="sd">        Aliases are read from</span>
<span class="sd">        [`all_aliases()`][optimade.server.mappers.entries.BaseResourceMapper.all_aliases].</span>

<span class="sd">        Arguments:</span>
<span class="sd">            backend_field: The backend field to attempt to map to an OPTIMADE field.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; get_optimade_field(&quot;chemical_formula_anonymous&quot;)</span>
<span class="sd">            &#39;chemical_formula_anonymous&#39;</span>
<span class="sd">            &gt;&gt;&gt; get_optimade_field(&quot;formula_anon&quot;)</span>
<span class="sd">            &#39;chemical_formula_anonymous&#39;</span>
<span class="sd">            &gt;&gt;&gt; get_optimade_field(&quot;custom_provider_field&quot;)</span>
<span class="sd">            &#39;_exmpl_custom_provider_field&#39;</span>

<span class="sd">        Returns:</span>
<span class="sd">            The mapped field name to be used in an OPTIMADE-compliant response.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">alias</span><span class="p">:</span> <span class="n">real</span> <span class="k">for</span> <span class="n">real</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">all_aliases</span><span class="p">()}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">backend_field</span><span class="p">,</span> <span class="n">backend_field</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">alias_of</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return de-aliased field name, if it exists,</span>
<span class="sd">        otherwise return the input field name.</span>

<span class="sd">        !!! warning &quot;Deprecated&quot;</span>
<span class="sd">            This method is deprecated could be removed without further warning. Please use</span>
<span class="sd">            [`get_optimade_field()`][optimade.server.mappers.entries.BaseResourceMapper.get_optimade_field].</span>

<span class="sd">        Parameters:</span>
<span class="sd">            field: Field name to be de-aliased.</span>

<span class="sd">        Returns:</span>
<span class="sd">            De-aliased field name, falling back to returning `field`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;The `.alias_of(...)` method is deprecated, please use `.get_optimade_field(...)`.&quot;</span><span class="p">,</span>
            <span class="ne">DeprecationWarning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">NUM_ENTRY_TYPES</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_required_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get REQUIRED response fields.</span>

<span class="sd">        Returns:</span>
<span class="sd">            REQUIRED response fields.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">map_back</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map properties from MongoDB to OPTIMADE.</span>

<span class="sd">        Starting from a MongoDB document `doc`, map the DB fields to the corresponding OPTIMADE fields.</span>
<span class="sd">        Then, the fields are all added to the top-level field &quot;attributes&quot;,</span>
<span class="sd">        with the exception of other top-level fields, defined in `cls.TOP_LEVEL_NON_ATTRIBUTES_FIELDS`.</span>
<span class="sd">        All fields not in `cls.TOP_LEVEL_NON_ATTRIBUTES_FIELDS` + &quot;attributes&quot; will be removed.</span>
<span class="sd">        Finally, the `type` is given the value of the specified `cls.ENDPOINT`.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            doc: A resource object in MongoDB format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A resource object in OPTIMADE format.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">((</span><span class="n">real</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span> <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">real</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">all_aliases</span><span class="p">())</span>
        <span class="n">newdoc</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">reals</span> <span class="o">=</span> <span class="p">{</span><span class="n">real</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">real</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">all_aliases</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reals</span><span class="p">:</span>
                <span class="n">newdoc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">real</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">real</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
                <span class="n">newdoc</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="n">real</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;attributes&quot;</span> <span class="ow">in</span> <span class="n">newdoc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Will overwrite doc field!&quot;</span><span class="p">)</span>
        <span class="n">attributes</span> <span class="o">=</span> <span class="n">newdoc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">newdoc</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">newdoc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">newdoc</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

        <span class="n">newdoc</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span>
        <span class="n">newdoc</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes</span>

        <span class="k">return</span> <span class="n">newdoc</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">],</span> <span class="n">EntryResource</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Converts the raw database entries for this class into serialized models,</span>
<span class="sd">        mapping the data along the way.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ENTRY_RESOURCE_CLASS</span><span class="p">(</span><span class="o">**</span><span class="bp">cls</span><span class="o">.</span><span class="n">map_back</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENTRY_RESOURCE_CLASS</span><span class="p">(</span><span class="o">**</span><span class="bp">cls</span><span class="o">.</span><span class="n">map_back</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.ALL_ATTRIBUTES" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">ALL_ATTRIBUTES</span><span class="p">()</span></code>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.ALL_ATTRIBUTES" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns all attributes served by this entry.</p>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classproperty</span>
<span class="k">def</span> <span class="nf">ALL_ATTRIBUTES</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns all attributes served by this entry.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">optimade.server.config</span> <span class="kn">import</span> <span class="n">CONFIG</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">set</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENTRY_RESOURCE_ATTRIBUTES</span><span class="p">)</span>
        <span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">())</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">())</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">PROVIDER_FIELDS</span><span class="p">})</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.ENDPOINT" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">ENDPOINT</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.ENDPOINT" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns the expected endpoint for this mapper, corresponding
to the <code>type</code> property of the resource class.</p>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classproperty</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">NUM_ENTRY_TYPES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ENDPOINT</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the expected endpoint for this mapper, corresponding</span>
<span class="sd">    to the `type` property of the resource class.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">endpoint</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ENTRY_RESOURCE_CLASS</span><span class="o">.</span><span class="n">model_fields</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">default</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">endpoint</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">endpoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Type not set for this entry type!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">endpoint</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.ENTRY_RESOURCE_ATTRIBUTES" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">ENTRY_RESOURCE_ATTRIBUTES</span><span class="p">()</span></code>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.ENTRY_RESOURCE_ATTRIBUTES" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns the dictionary of attributes defined by the underlying entry resource class.</p>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classproperty</span>
<span class="k">def</span> <span class="nf">ENTRY_RESOURCE_ATTRIBUTES</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the dictionary of attributes defined by the underlying entry resource class.&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">optimade.server.schemas</span> <span class="kn">import</span> <span class="n">retrieve_queryable_properties</span>

    <span class="k">return</span> <span class="n">retrieve_queryable_properties</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENTRY_RESOURCE_CLASS</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.SUPPORTED_PREFIXES" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">SUPPORTED_PREFIXES</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.SUPPORTED_PREFIXES" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>A set of prefixes handled by this entry type.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This implementation only includes the provider prefix,
but in the future this property may be extended to include other
namespaces (for serving fields from, e.g., other providers or
domain-specific terms).</p>
</div>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classproperty</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">SUPPORTED_PREFIXES</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A set of prefixes handled by this entry type.</span>

<span class="sd">    !!! note</span>
<span class="sd">        This implementation only includes the provider prefix,</span>
<span class="sd">        but in the future this property may be extended to include other</span>
<span class="sd">        namespaces (for serving fields from, e.g., other providers or</span>
<span class="sd">        domain-specific terms).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">optimade.server.config</span> <span class="kn">import</span> <span class="n">CONFIG</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">prefix</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.alias_for" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">alias_for</span><span class="p">(</span><span class="n">field</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.alias_for" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return aliased field name.</p>
<div class="admonition warning">
<p class="admonition-title">Deprecated</p>
<p>This method is deprecated could be removed without further warning. Please use
<a class="autorefs autorefs-internal" href="../../mappers/entries/#optimade.server.mappers.entries.BaseResourceMapper.get_backend_field"><code>get_backend_field()</code></a>.</p>
</div>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>field</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>OPTIMADE field name.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Aliased field as found in <a class="autorefs autorefs-internal" href="../../mappers/entries/#optimade.server.mappers.entries.BaseResourceMapper.all_aliases"><code>all_aliases()</code></a>.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">alias_for</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return aliased field name.</span>

<span class="sd">    !!! warning &quot;Deprecated&quot;</span>
<span class="sd">        This method is deprecated could be removed without further warning. Please use</span>
<span class="sd">        [`get_backend_field()`][optimade.server.mappers.entries.BaseResourceMapper.get_backend_field].</span>

<span class="sd">    Parameters:</span>
<span class="sd">        field: OPTIMADE field name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Aliased field as found in [`all_aliases()`][optimade.server.mappers.entries.BaseResourceMapper.all_aliases].</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;The `.alias_for(...)` method is deprecated, please use `.get_backend_field(...)`.&quot;</span><span class="p">,</span>
        <span class="ne">DeprecationWarning</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_backend_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.alias_of" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">alias_of</span><span class="p">(</span><span class="n">field</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.alias_of" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return de-aliased field name, if it exists,
otherwise return the input field name.</p>
<div class="admonition warning">
<p class="admonition-title">Deprecated</p>
<p>This method is deprecated could be removed without further warning. Please use
<a class="autorefs autorefs-internal" href="../../mappers/entries/#optimade.server.mappers.entries.BaseResourceMapper.get_optimade_field"><code>get_optimade_field()</code></a>.</p>
</div>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>field</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Field name to be de-aliased.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>De-aliased field name, falling back to returning <code>field</code>.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">alias_of</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return de-aliased field name, if it exists,</span>
<span class="sd">    otherwise return the input field name.</span>

<span class="sd">    !!! warning &quot;Deprecated&quot;</span>
<span class="sd">        This method is deprecated could be removed without further warning. Please use</span>
<span class="sd">        [`get_optimade_field()`][optimade.server.mappers.entries.BaseResourceMapper.get_optimade_field].</span>

<span class="sd">    Parameters:</span>
<span class="sd">        field: Field name to be de-aliased.</span>

<span class="sd">    Returns:</span>
<span class="sd">        De-aliased field name, falling back to returning `field`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
        <span class="s2">&quot;The `.alias_of(...)` method is deprecated, please use `.get_optimade_field(...)`.&quot;</span><span class="p">,</span>
        <span class="ne">DeprecationWarning</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.all_aliases" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">all_aliases</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.all_aliases" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns all of the associated aliases for this entry type,
including those defined by the server config. The first member
of each tuple is the OPTIMADE-compliant field name, the second
is the backend-specific field name.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="collections.abc.Iterable">Iterable</span>[tuple[str, str]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A tuple of alias tuples.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">NUM_ENTRY_TYPES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">all_aliases</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns all of the associated aliases for this entry type,</span>
<span class="sd">    including those defined by the server config. The first member</span>
<span class="sd">    of each tuple is the OPTIMADE-compliant field name, the second</span>
<span class="sd">    is the backend-specific field name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of alias tuples.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">optimade.server.config</span> <span class="kn">import</span> <span class="n">CONFIG</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span>
            <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">PROVIDER_FIELDS</span>
        <span class="p">)</span>
        <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="o">+</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ALIASES</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.all_length_aliases" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">all_length_aliases</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.all_length_aliases" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns all of the associated length aliases for this class,
including those defined by the server config.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>tuple[tuple[str, str], ...]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A tuple of length alias tuples.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">NUM_ENTRY_TYPES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">all_length_aliases</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="o">...</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns all of the associated length aliases for this class,</span>
<span class="sd">    including those defined by the server config.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of length alias tuples.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">optimade.server.config</span> <span class="kn">import</span> <span class="n">CONFIG</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">LENGTH_ALIASES</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span>
        <span class="n">CONFIG</span><span class="o">.</span><span class="n">length_aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.deserialize" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">deserialize</span><span class="p">(</span><span class="n">results</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.deserialize" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Converts the raw database entries for this class into serialized models,
mapping the data along the way.</p>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span> <span class="n">results</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">]]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">],</span> <span class="n">EntryResource</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts the raw database entries for this class into serialized models,</span>
<span class="sd">    mapping the data along the way.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ENTRY_RESOURCE_CLASS</span><span class="p">(</span><span class="o">**</span><span class="bp">cls</span><span class="o">.</span><span class="n">map_back</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">ENTRY_RESOURCE_CLASS</span><span class="p">(</span><span class="o">**</span><span class="bp">cls</span><span class="o">.</span><span class="n">map_back</span><span class="p">(</span><span class="n">doc</span><span class="p">))</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.get_backend_field" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_backend_field</span><span class="p">(</span><span class="n">optimade_field</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.get_backend_field" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return the field name configured for the particular
underlying database for the passed OPTIMADE field name, that would
be used in an API filter.</p>
<p>Aliases are read from
<a class="autorefs autorefs-internal" href="../../mappers/entries/#optimade.server.mappers.entries.BaseResourceMapper.all_aliases"><code>all_aliases()</code></a>.</p>
<p>If a dot-separated OPTIMADE field is provided, e.g., <code>species.mass</code>, only the first part will be mapped.
This means for an (OPTIMADE, DB) alias of (<code>species</code>, <code>kinds</code>), <code>get_backend_fields("species.mass")</code>
will return <code>kinds.mass</code>.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>optimade_field</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The OPTIMADE field to attempt to map to the backend-specific field.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">get_backend_field</span><span class="p">(</span><span class="s2">&quot;chemical_formula_anonymous&quot;</span><span class="p">)</span>
<span class="go">&#39;formula_anon&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_backend_field</span><span class="p">(</span><span class="s2">&quot;formula_anon&quot;</span><span class="p">)</span>
<span class="go">&#39;formula_anon&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_backend_field</span><span class="p">(</span><span class="s2">&quot;_exmpl_custom_provider_field&quot;</span><span class="p">)</span>
<span class="go">&#39;custom_provider_field&#39;</span>
</code></pre></div>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The mapped field name to be used in the query to the backend.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_backend_field</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">optimade_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the field name configured for the particular</span>
<span class="sd">    underlying database for the passed OPTIMADE field name, that would</span>
<span class="sd">    be used in an API filter.</span>

<span class="sd">    Aliases are read from</span>
<span class="sd">    [`all_aliases()`][optimade.server.mappers.entries.BaseResourceMapper.all_aliases].</span>

<span class="sd">    If a dot-separated OPTIMADE field is provided, e.g., `species.mass`, only the first part will be mapped.</span>
<span class="sd">    This means for an (OPTIMADE, DB) alias of (`species`, `kinds`), `get_backend_fields(&quot;species.mass&quot;)`</span>
<span class="sd">    will return `kinds.mass`.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        optimade_field: The OPTIMADE field to attempt to map to the backend-specific field.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; get_backend_field(&quot;chemical_formula_anonymous&quot;)</span>
<span class="sd">        &#39;formula_anon&#39;</span>
<span class="sd">        &gt;&gt;&gt; get_backend_field(&quot;formula_anon&quot;)</span>
<span class="sd">        &#39;formula_anon&#39;</span>
<span class="sd">        &gt;&gt;&gt; get_backend_field(&quot;_exmpl_custom_provider_field&quot;)</span>
<span class="sd">        &#39;custom_provider_field&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        The mapped field name to be used in the query to the backend.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">optimade_field</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">alias</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">all_aliases</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">alias</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">alias</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">optimade_field</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.get_optimade_field" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">backend_field</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.get_optimade_field" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Return the corresponding OPTIMADE field name for the underlying database field,
ready to be used to construct the OPTIMADE-compliant JSON response.</p>
<p>Aliases are read from
<a class="autorefs autorefs-internal" href="../../mappers/entries/#optimade.server.mappers.entries.BaseResourceMapper.all_aliases"><code>all_aliases()</code></a>.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>backend_field</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The backend field to attempt to map to an OPTIMADE field.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



<p><strong>Examples:</strong></p>
    <div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">get_optimade_field</span><span class="p">(</span><span class="s2">&quot;chemical_formula_anonymous&quot;</span><span class="p">)</span>
<span class="go">&#39;chemical_formula_anonymous&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_optimade_field</span><span class="p">(</span><span class="s2">&quot;formula_anon&quot;</span><span class="p">)</span>
<span class="go">&#39;chemical_formula_anonymous&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">get_optimade_field</span><span class="p">(</span><span class="s2">&quot;custom_provider_field&quot;</span><span class="p">)</span>
<span class="go">&#39;_exmpl_custom_provider_field&#39;</span>
</code></pre></div>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The mapped field name to be used in an OPTIMADE-compliant response.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_optimade_field</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">backend_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the corresponding OPTIMADE field name for the underlying database field,</span>
<span class="sd">    ready to be used to construct the OPTIMADE-compliant JSON response.</span>

<span class="sd">    Aliases are read from</span>
<span class="sd">    [`all_aliases()`][optimade.server.mappers.entries.BaseResourceMapper.all_aliases].</span>

<span class="sd">    Arguments:</span>
<span class="sd">        backend_field: The backend field to attempt to map to an OPTIMADE field.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; get_optimade_field(&quot;chemical_formula_anonymous&quot;)</span>
<span class="sd">        &#39;chemical_formula_anonymous&#39;</span>
<span class="sd">        &gt;&gt;&gt; get_optimade_field(&quot;formula_anon&quot;)</span>
<span class="sd">        &#39;chemical_formula_anonymous&#39;</span>
<span class="sd">        &gt;&gt;&gt; get_optimade_field(&quot;custom_provider_field&quot;)</span>
<span class="sd">        &#39;_exmpl_custom_provider_field&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        The mapped field name to be used in an OPTIMADE-compliant response.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">alias</span><span class="p">:</span> <span class="n">real</span> <span class="k">for</span> <span class="n">real</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">all_aliases</span><span class="p">()}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">backend_field</span><span class="p">,</span> <span class="n">backend_field</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.get_required_fields" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_required_fields</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.get_required_fields" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Get REQUIRED response fields.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>set</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>REQUIRED response fields.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="n">NUM_ENTRY_TYPES</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_required_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get REQUIRED response fields.</span>

<span class="sd">    Returns:</span>
<span class="sd">        REQUIRED response fields.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.length_alias_for" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">length_alias_for</span><span class="p">(</span><span class="n">field</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.length_alias_for" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns the length alias for the particular field,
or <code>None</code> if no such alias is found.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>field</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>OPTIMADE field name.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Aliased field as found in <a class="autorefs autorefs-internal" href="../../mappers/entries/#optimade.server.mappers.entries.BaseResourceMapper.all_length_aliases"><code>all_length_aliases()</code></a>.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">length_alias_for</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the length alias for the particular field,</span>
<span class="sd">    or `None` if no such alias is found.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        field: OPTIMADE field name.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Aliased field as found in [`all_length_aliases()`][optimade.server.mappers.entries.BaseResourceMapper.all_length_aliases].</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">all_length_aliases</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.BaseResourceMapper.map_back" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">map_back</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.BaseResourceMapper.map_back" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Map properties from MongoDB to OPTIMADE.</p>
<p>Starting from a MongoDB document <code>doc</code>, map the DB fields to the corresponding OPTIMADE fields.
Then, the fields are all added to the top-level field "attributes",
with the exception of other top-level fields, defined in <code>cls.TOP_LEVEL_NON_ATTRIBUTES_FIELDS</code>.
All fields not in <code>cls.TOP_LEVEL_NON_ATTRIBUTES_FIELDS</code> + "attributes" will be removed.
Finally, the <code>type</code> is given the value of the specified <code>cls.ENDPOINT</code>.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>doc</code></td>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A resource object in MongoDB format.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>dict</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A resource object in OPTIMADE format.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/mappers/entries.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">map_back</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">doc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Map properties from MongoDB to OPTIMADE.</span>

<span class="sd">    Starting from a MongoDB document `doc`, map the DB fields to the corresponding OPTIMADE fields.</span>
<span class="sd">    Then, the fields are all added to the top-level field &quot;attributes&quot;,</span>
<span class="sd">    with the exception of other top-level fields, defined in `cls.TOP_LEVEL_NON_ATTRIBUTES_FIELDS`.</span>
<span class="sd">    All fields not in `cls.TOP_LEVEL_NON_ATTRIBUTES_FIELDS` + &quot;attributes&quot; will be removed.</span>
<span class="sd">    Finally, the `type` is given the value of the specified `cls.ENDPOINT`.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        doc: A resource object in MongoDB format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A resource object in OPTIMADE format.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">((</span><span class="n">real</span><span class="p">,</span> <span class="n">alias</span><span class="p">)</span> <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">real</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">all_aliases</span><span class="p">())</span>
    <span class="n">newdoc</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">reals</span> <span class="o">=</span> <span class="p">{</span><span class="n">real</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">real</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">all_aliases</span><span class="p">()}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reals</span><span class="p">:</span>
            <span class="n">newdoc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">real</span><span class="p">,</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">real</span> <span class="ow">in</span> <span class="n">doc</span><span class="p">:</span>
            <span class="n">newdoc</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="n">real</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;attributes&quot;</span> <span class="ow">in</span> <span class="n">newdoc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Will overwrite doc field!&quot;</span><span class="p">)</span>
    <span class="n">attributes</span> <span class="o">=</span> <span class="n">newdoc</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">newdoc</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">newdoc</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">newdoc</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>

    <span class="n">newdoc</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ENDPOINT</span>
    <span class="n">newdoc</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">attributes</span>

    <span class="k">return</span> <span class="n">newdoc</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="optimade.server.entry_collections.mongo.EntryCollection" class="doc doc-heading">
          <code>EntryCollection</code>


<a href="#optimade.server.entry_collections.mongo.EntryCollection" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="abc.ABC">ABC</span></code></p>

  
      <p>Backend-agnostic base class for querying collections of
<a class="autorefs autorefs-internal" href="../../../models/entries/#optimade.models.entries.EntryResource"><code>EntryResource</code></a>s.</p>

            <details class="quote">
              <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">EntryCollection</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Backend-agnostic base class for querying collections of</span>
<span class="sd">    [`EntryResource`][optimade.models.entries.EntryResource]s.&quot;&quot;&quot;</span>

    <span class="n">pagination_mechanism</span> <span class="o">=</span> <span class="n">PaginationMechanism</span><span class="p">(</span><span class="s2">&quot;page_offset&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The default pagination mechansim to use with a given collection,</span>
<span class="sd">    if the user does not provide any pagination query parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">resource_cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">],</span>
        <span class="n">resource_mapper</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseResourceMapper</span><span class="p">],</span>
        <span class="n">transformer</span><span class="p">:</span> <span class="n">Transformer</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the collection for the given parameters.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            resource_cls (EntryResource): The `EntryResource` model</span>
<span class="sd">                that is stored by the collection.</span>
<span class="sd">            resource_mapper (BaseResourceMapper): A resource mapper</span>
<span class="sd">                object that handles aliases and format changes between</span>
<span class="sd">                deserialization and response.</span>
<span class="sd">            transformer (Transformer): The Lark `Transformer` used to</span>
<span class="sd">                interpret the filter.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">LarkParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_cls</span> <span class="o">=</span> <span class="n">resource_cls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span> <span class="o">=</span> <span class="n">resource_mapper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">provider_prefix</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">provider_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">field</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_all_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the total number of entries in the collection.&quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the given entries to the underlying database.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            data: The entry resource objects to add to the database.</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of entries matching the query specified</span>
<span class="sd">        by the keyword arguments.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            **kwargs: Query parameters as keyword arguments.</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EntryListingQueryParams</span><span class="p">,</span> <span class="n">SingleEntryQueryParams</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]],</span>
        <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="nb">bool</span><span class="p">,</span>
        <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetches results and indicates if more data is available.</span>

<span class="sd">        Also gives the total number of data available in the absence of `page_limit`.</span>
<span class="sd">        See [`EntryListingQueryParams`][optimade.server.query_params.EntryListingQueryParams]</span>
<span class="sd">        for more information.</span>

<span class="sd">        Returns a list of the mapped database reponse.</span>

<span class="sd">        If no results match the query, then `results` is set to `None`.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            params: Entry listing URL query params.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple of various relevant values:</span>
<span class="sd">            (`results`, `data_returned`, `more_data_available`, `exclude_fields`, `include_fields`).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_query_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">single_entry</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SingleEntryQueryParams</span><span class="p">)</span>
        <span class="n">response_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fields&quot;</span><span class="p">)</span>

        <span class="n">raw_results</span><span class="p">,</span> <span class="n">data_returned</span><span class="p">,</span> <span class="n">more_data_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_db_query</span><span class="p">(</span>
            <span class="n">criteria</span><span class="p">,</span> <span class="n">single_entry</span>
        <span class="p">)</span>

        <span class="n">exclude_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fields</span> <span class="o">-</span> <span class="n">response_fields</span>
        <span class="n">include_fields</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">response_fields</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span>
        <span class="p">)</span>

        <span class="n">bad_optimade_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">bad_provider_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">supported_prefixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">SUPPORTED_PREFIXES</span>
        <span class="n">all_attributes</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">ALL_ATTRIBUTES</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">include_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_attributes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                        <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">supported_prefixes</span>
                    <span class="p">):</span>
                        <span class="n">bad_provider_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">bad_optimade_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bad_provider_fields</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unrecognised field(s) for this provider requested in `response_fields`: </span><span class="si">{</span><span class="n">bad_provider_fields</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="n">UnknownProviderProperty</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">bad_optimade_fields</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span>
                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unrecognised OPTIMADE field(s) in requested `response_fields`: </span><span class="si">{</span><span class="n">bad_optimade_fields</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">raw_results</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">map_back</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">raw_results</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">single_entry</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">CONFIG</span><span class="o">.</span><span class="n">validate_api_response</span>
                    <span class="ow">and</span> <span class="n">data_returned</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                    <span class="ow">and</span> <span class="n">data_returned</span> <span class="o">&gt;</span> <span class="mi">1</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span>
                        <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Instead of a single entry, </span><span class="si">{</span><span class="n">data_returned</span><span class="si">}</span><span class="s2"> entries were found&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">data_returned</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">results</span><span class="p">,</span>
            <span class="n">data_returned</span><span class="p">,</span>
            <span class="n">more_data_available</span><span class="p">,</span>
            <span class="n">exclude_fields</span><span class="p">,</span>
            <span class="n">include_fields</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_run_db_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">single_entry</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the query on the backend and collect the results.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            criteria: A dictionary representation of the query parameters.</span>
<span class="sd">            single_entry: Whether or not the caller is expecting a single entry response.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of entries from the database (without any re-mapping), the total number of</span>
<span class="sd">            entries matching the query and a boolean for whether or not there is more data available.</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the set of all fields handled in this collection,</span>
<span class="sd">        from attribute fields in the schema, provider fields and top-level OPTIMADE fields.</span>

<span class="sd">        The set of all fields are lazily created and then cached.</span>
<span class="sd">        This means the set is created the first time the property is requested and then cached.</span>

<span class="sd">        Returns:</span>
<span class="sd">            All fields handled in this collection.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_fields</span><span class="p">:</span>
            <span class="c1"># All OPTIMADE fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_fields</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_fields</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attribute_fields</span><span class="p">()</span>
            <span class="c1"># All provider-specific fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_all_fields</span> <span class="o">|=</span> <span class="p">{</span>
                <span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_prefix</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="n">field_name</span>
                <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">provider_fields</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_all_fields</span>

    <span class="k">def</span> <span class="nf">get_attribute_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the set of attribute fields</span>

<span class="sd">        Return only the _first-level_ attribute fields from the schema of the resource class,</span>
<span class="sd">        resolving references along the way if needed.</span>

<span class="sd">        Note:</span>
<span class="sd">            It is not needed to take care of other special OpenAPI schema keys than `allOf`,</span>
<span class="sd">            since only `allOf` will be found in this context.</span>
<span class="sd">            Other special keys can be found in [the Swagger documentation](https://swagger.io/docs/specification/data-models/oneof-anyof-allof-not/).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Property names.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">_get_origin_type</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resource_cls</span><span class="o">.</span><span class="n">model_fields</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">annotation</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">Attributes</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;resource class &#39;attributes&#39; field must be a subclass of &#39;EntryResourceAttributes&#39;&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">model_fields</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>

    <span class="k">def</span> <span class="nf">handle_query_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EntryListingQueryParams</span><span class="p">,</span> <span class="n">SingleEntryQueryParams</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse and interpret the backend-agnostic query parameter models into a dictionary</span>
<span class="sd">        that can be used by the specific backend.</span>

<span class="sd">        Note:</span>
<span class="sd">            Currently this method returns the pymongo interpretation of the parameters,</span>
<span class="sd">            which will need modification for modified for other backends.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            params: The initialized query parameter model from the server.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Forbidden: If too large of a page limit is provided.</span>
<span class="sd">            BadRequest: If an invalid request is made, e.g., with incorrect fields</span>
<span class="sd">                or response format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary representation of the query parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># filter</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>  <span class="c1"># type: ignore[union-attr]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># response_format</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;response_format&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">response_format</span> <span class="o">!=</span> <span class="s2">&quot;json&quot;</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span>
                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Response format </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">response_format</span><span class="si">}</span><span class="s2"> is not supported, please use response_format=&#39;json&#39;&quot;</span>
            <span class="p">)</span>

        <span class="c1"># page_limit</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;page_limit&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">limit</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">page_limit</span>  <span class="c1"># type: ignore[union-attr]</span>
            <span class="k">if</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">page_limit_max</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Forbidden</span><span class="p">(</span>
                    <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Max allowed page_limit is </span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">page_limit_max</span><span class="si">}</span><span class="s2">, you requested </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">page_limit</span>

        <span class="c1"># response_fields</span>
        <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">get_backend_field</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fields</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;response_fields&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">response_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">response_fields</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
            <span class="n">response_fields</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">get_required_fields</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fields</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_fields</span>

        <span class="c1"># sort</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;sort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_sort_params</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>  <span class="c1"># type: ignore[union-attr]</span>

        <span class="c1"># warn if multiple pagination keys are present, and only use the first from this list</span>
        <span class="n">received_pagination_option</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">warn_multiple_keys</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;page_offset&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">received_pagination_option</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;skip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">page_offset</span>  <span class="c1"># type: ignore[union-attr]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;page_number&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">received_pagination_option</span><span class="p">:</span>
                <span class="n">warn_multiple_keys</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">received_pagination_option</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">page_number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># type: ignore[union-attr]</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&#39;page_number&#39; is 1-based, using &#39;page_number=1&#39; instead of </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">page_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore[union-attr]</span>
                        <span class="n">category</span><span class="o">=</span><span class="n">QueryParamNotUsed</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">page_number</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">page_number</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">page_number</span>  <span class="c1"># type: ignore[union-attr]</span>
                <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;skip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;page_above&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">received_pagination_option</span><span class="p">:</span>
                <span class="n">warn_multiple_keys</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">received_pagination_option</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;page_above&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">page_above</span>  <span class="c1"># type: ignore[union-attr]</span>

        <span class="k">if</span> <span class="n">warn_multiple_keys</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Multiple pagination keys were provided, only using the first one of &#39;page_offset&#39;, &#39;page_number&#39; or &#39;page_above&#39;&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="n">QueryParamNotUsed</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">cursor_kwargs</span>

    <span class="k">def</span> <span class="nf">parse_sort_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_params</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handles any sort parameters passed to the collection,</span>
<span class="sd">        resolving aliases and dealing with any invalid fields.</span>

<span class="sd">        Raises:</span>
<span class="sd">            BadRequest: if an invalid sort is requested.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list of tuples containing the aliased field name and</span>
<span class="sd">            sort direction encoded as 1 (ascending) or -1 (descending).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sort_spec</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">sort_params</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
            <span class="n">sort_dir</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">sort_dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">aliased_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">get_backend_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="n">sort_spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">aliased_field</span><span class="p">,</span> <span class="n">sort_dir</span><span class="p">))</span>

        <span class="n">unknown_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">field</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sort_spec</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fields</span>
        <span class="p">]</span>

        <span class="k">if</span> <span class="n">unknown_fields</span><span class="p">:</span>
            <span class="n">error_detail</span> <span class="o">=</span> <span class="s2">&quot;Unable to sort on unknown field</span><span class="si">{}</span><span class="s2"> &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="s2">&quot;&#39;, &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="c1"># If all unknown fields are &quot;other&quot; provider-specific, then only provide a warning</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;_[a-z_0-9]+_[a-z_0-9]*&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_prefix</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">unknown_fields</span>
            <span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">error_detail</span><span class="p">,</span> <span class="n">FieldValueNotRecognized</span><span class="p">)</span>

            <span class="c1"># Otherwise, if all fields are unknown, or some fields are unknown and do not</span>
            <span class="c1"># have other provider prefixes, then return 400: Bad Request</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="n">error_detail</span><span class="p">)</span>

        <span class="c1"># If at least one valid field has been provided for sorting, then use that</span>
        <span class="n">sort_spec</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">sort_dir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">sort_dir</span> <span class="ow">in</span> <span class="n">sort_spec</span>
            <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unknown_fields</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">sort_spec</span>

    <span class="k">def</span> <span class="nf">get_next_query_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">EntryListingQueryParams</span><span class="p">,</span>
        <span class="n">results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides url query pagination parameters that will be used in the next</span>
<span class="sd">        link.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            results: The results produced by find.</span>
<span class="sd">            params: The parsed request params produced by handle_query_params.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary with the necessary query parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">results</span><span class="p">:</span>
            <span class="c1"># If a user passed a particular pagination mechanism, keep using it</span>
            <span class="c1"># Otherwise, use the default pagination mechanism of the collection</span>
            <span class="n">pagination_mechanism</span> <span class="o">=</span> <span class="n">PaginationMechanism</span><span class="o">.</span><span class="n">OFFSET</span>
            <span class="k">for</span> <span class="n">pagination_key</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;page_offset&quot;</span><span class="p">,</span>
                <span class="s2">&quot;page_number&quot;</span><span class="p">,</span>
                <span class="s2">&quot;page_above&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pagination_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pagination_mechanism</span> <span class="o">=</span> <span class="n">PaginationMechanism</span><span class="p">(</span><span class="n">pagination_key</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">pagination_mechanism</span> <span class="o">==</span> <span class="n">PaginationMechanism</span><span class="o">.</span><span class="n">OFFSET</span><span class="p">:</span>
                <span class="n">query</span><span class="p">[</span><span class="s2">&quot;page_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">page_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>  <span class="c1"># type: ignore[list-item]</span>
                <span class="p">]</span>

        <span class="k">return</span> <span class="n">query</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.all_fields" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">all_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.all_fields" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Get the set of all fields handled in this collection,
from attribute fields in the schema, provider fields and top-level OPTIMADE fields.</p>
<p>The set of all fields are lazily created and then cached.
This means the set is created the first time the property is requested and then cached.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>set[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>All fields handled in this collection.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.pagination_mechanism" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pagination_mechanism</span> <span class="o">=</span> <span class="n">PaginationMechanism</span><span class="p">(</span><span class="s1">&#39;page_offset&#39;</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.pagination_mechanism" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>The default pagination mechansim to use with a given collection,
if the user does not provide any pagination query parameters.</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">resource_cls</span><span class="p">,</span> <span class="n">resource_mapper</span><span class="p">,</span> <span class="n">transformer</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Initialize the collection for the given parameters.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>resource_cls</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="optimade.models.EntryResource" href="../../../../all_models/#optimade.models.EntryResource">EntryResource</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The <code>EntryResource</code> model
that is stored by the collection.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>resource_mapper</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="optimade.server.mappers.BaseResourceMapper" href="../../mappers/entries/#optimade.server.mappers.entries.BaseResourceMapper">BaseResourceMapper</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A resource mapper
object that handles aliases and format changes between
deserialization and response.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>transformer</code></td>
          <td>
                <code><span title="lark.Transformer">Transformer</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The Lark <code>Transformer</code> used to
interpret the filter.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">resource_cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">],</span>
    <span class="n">resource_mapper</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseResourceMapper</span><span class="p">],</span>
    <span class="n">transformer</span><span class="p">:</span> <span class="n">Transformer</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the collection for the given parameters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        resource_cls (EntryResource): The `EntryResource` model</span>
<span class="sd">            that is stored by the collection.</span>
<span class="sd">        resource_mapper (BaseResourceMapper): A resource mapper</span>
<span class="sd">            object that handles aliases and format changes between</span>
<span class="sd">            deserialization and response.</span>
<span class="sd">        transformer (Transformer): The Lark `Transformer` used to</span>
<span class="sd">            interpret the filter.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">LarkParser</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resource_cls</span> <span class="o">=</span> <span class="n">resource_cls</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span> <span class="o">=</span> <span class="n">resource_mapper</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="n">transformer</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">provider_prefix</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">prefix</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">provider_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">field</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">field</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">provider_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">ENDPOINT</span><span class="p">,</span> <span class="p">[])</span>
    <span class="p">]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_all_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.__len__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.__len__" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns the total number of entries in the collection.</p>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the total number of entries in the collection.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.count" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">count</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.count" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns the number of entries matching the query specified
by the keyword arguments.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>**kwargs</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Query parameters as keyword arguments.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the number of entries matching the query specified</span>
<span class="sd">    by the keyword arguments.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        **kwargs: Query parameters as keyword arguments.</span>

<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.find" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.find" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Fetches results and indicates if more data is available.</p>
<p>Also gives the total number of data available in the absence of <code>page_limit</code>.
See <a class="autorefs autorefs-internal" href="../../query_params/#optimade.server.query_params.EntryListingQueryParams"><code>EntryListingQueryParams</code></a>
for more information.</p>
<p>Returns a list of the mapped database reponse.</p>
<p>If no results match the query, then <code>results</code> is set to <code>None</code>.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="optimade.server.query_params.EntryListingQueryParams" href="../../query_params/#optimade.server.query_params.EntryListingQueryParams">EntryListingQueryParams</a>, <a class="autorefs autorefs-internal" title="optimade.server.query_params.SingleEntryQueryParams" href="../../query_params/#optimade.server.query_params.SingleEntryQueryParams">SingleEntryQueryParams</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Entry listing URL query params.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[dict[str, <span title="typing.Any">Any</span>], list[dict[str, <span title="typing.Any">Any</span>]]]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A tuple of various relevant values:</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>(<code>results</code>, <code>data_returned</code>, <code>more_data_available</code>, <code>exclude_fields</code>, <code>include_fields</code>).</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">find</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EntryListingQueryParams</span><span class="p">,</span> <span class="n">SingleEntryQueryParams</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
    <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]],</span>
    <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="nb">bool</span><span class="p">,</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches results and indicates if more data is available.</span>

<span class="sd">    Also gives the total number of data available in the absence of `page_limit`.</span>
<span class="sd">    See [`EntryListingQueryParams`][optimade.server.query_params.EntryListingQueryParams]</span>
<span class="sd">    for more information.</span>

<span class="sd">    Returns a list of the mapped database reponse.</span>

<span class="sd">    If no results match the query, then `results` is set to `None`.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        params: Entry listing URL query params.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of various relevant values:</span>
<span class="sd">        (`results`, `data_returned`, `more_data_available`, `exclude_fields`, `include_fields`).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_query_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">single_entry</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SingleEntryQueryParams</span><span class="p">)</span>
    <span class="n">response_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fields&quot;</span><span class="p">)</span>

    <span class="n">raw_results</span><span class="p">,</span> <span class="n">data_returned</span><span class="p">,</span> <span class="n">more_data_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_db_query</span><span class="p">(</span>
        <span class="n">criteria</span><span class="p">,</span> <span class="n">single_entry</span>
    <span class="p">)</span>

    <span class="n">exclude_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fields</span> <span class="o">-</span> <span class="n">response_fields</span>
    <span class="n">include_fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">response_fields</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span>
    <span class="p">)</span>

    <span class="n">bad_optimade_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">bad_provider_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">supported_prefixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">SUPPORTED_PREFIXES</span>
    <span class="n">all_attributes</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">ALL_ATTRIBUTES</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">include_fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">supported_prefixes</span>
                <span class="p">):</span>
                    <span class="n">bad_provider_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bad_optimade_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bad_provider_fields</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unrecognised field(s) for this provider requested in `response_fields`: </span><span class="si">{</span><span class="n">bad_provider_fields</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="n">UnknownProviderProperty</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">bad_optimade_fields</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unrecognised OPTIMADE field(s) in requested `response_fields`: </span><span class="si">{</span><span class="n">bad_optimade_fields</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="n">results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">raw_results</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">map_back</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">raw_results</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">single_entry</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">CONFIG</span><span class="o">.</span><span class="n">validate_api_response</span>
                <span class="ow">and</span> <span class="n">data_returned</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">data_returned</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span>
                    <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Instead of a single entry, </span><span class="si">{</span><span class="n">data_returned</span><span class="si">}</span><span class="s2"> entries were found&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_returned</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">results</span><span class="p">,</span>
        <span class="n">data_returned</span><span class="p">,</span>
        <span class="n">more_data_available</span><span class="p">,</span>
        <span class="n">exclude_fields</span><span class="p">,</span>
        <span class="n">include_fields</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.get_attribute_fields" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_attribute_fields</span><span class="p">()</span></code>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.get_attribute_fields" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Get the set of attribute fields</p>
<p>Return only the <em>first-level</em> attribute fields from the schema of the resource class,
resolving references along the way if needed.</p>

<details class="note" open>
  <summary>Note</summary>
  <p>It is not needed to take care of other special OpenAPI schema keys than <code>allOf</code>,
since only <code>allOf</code> will be found in this context.
Other special keys can be found in <a href="https://swagger.io/docs/specification/data-models/oneof-anyof-allof-not/">the Swagger documentation</a>.</p>
</details>


  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>set[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Property names.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_attribute_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the set of attribute fields</span>

<span class="sd">    Return only the _first-level_ attribute fields from the schema of the resource class,</span>
<span class="sd">    resolving references along the way if needed.</span>

<span class="sd">    Note:</span>
<span class="sd">        It is not needed to take care of other special OpenAPI schema keys than `allOf`,</span>
<span class="sd">        since only `allOf` will be found in this context.</span>
<span class="sd">        Other special keys can be found in [the Swagger documentation](https://swagger.io/docs/specification/data-models/oneof-anyof-allof-not/).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Property names.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">_get_origin_type</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_cls</span><span class="o">.</span><span class="n">model_fields</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">annotation</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">Attributes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;resource class &#39;attributes&#39; field must be a subclass of &#39;EntryResourceAttributes&#39;&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">model_fields</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.get_next_query_params" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_next_query_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.get_next_query_params" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Provides url query pagination parameters that will be used in the next
link.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>results</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[dict[str, <span title="typing.Any">Any</span>], list[dict[str, <span title="typing.Any">Any</span>]]]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The results produced by find.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="optimade.server.query_params.EntryListingQueryParams" href="../../query_params/#optimade.server.query_params.EntryListingQueryParams">EntryListingQueryParams</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The parsed request params produced by handle_query_params.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>dict[str, list[str]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary with the necessary query parameters.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_next_query_params</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">EntryListingQueryParams</span><span class="p">,</span>
    <span class="n">results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides url query pagination parameters that will be used in the next</span>
<span class="sd">    link.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        results: The results produced by find.</span>
<span class="sd">        params: The parsed request params produced by handle_query_params.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with the necessary query parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">results</span><span class="p">:</span>
        <span class="c1"># If a user passed a particular pagination mechanism, keep using it</span>
        <span class="c1"># Otherwise, use the default pagination mechanism of the collection</span>
        <span class="n">pagination_mechanism</span> <span class="o">=</span> <span class="n">PaginationMechanism</span><span class="o">.</span><span class="n">OFFSET</span>
        <span class="k">for</span> <span class="n">pagination_key</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;page_offset&quot;</span><span class="p">,</span>
            <span class="s2">&quot;page_number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;page_above&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pagination_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pagination_mechanism</span> <span class="o">=</span> <span class="n">PaginationMechanism</span><span class="p">(</span><span class="n">pagination_key</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">pagination_mechanism</span> <span class="o">==</span> <span class="n">PaginationMechanism</span><span class="o">.</span><span class="n">OFFSET</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;page_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">page_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>  <span class="c1"># type: ignore[list-item]</span>
            <span class="p">]</span>

    <span class="k">return</span> <span class="n">query</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.handle_query_params" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">handle_query_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.handle_query_params" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Parse and interpret the backend-agnostic query parameter models into a dictionary
that can be used by the specific backend.</p>

<details class="note" open>
  <summary>Note</summary>
  <p>Currently this method returns the pymongo interpretation of the parameters,
which will need modification for modified for other backends.</p>
</details>


  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="optimade.server.query_params.EntryListingQueryParams" href="../../query_params/#optimade.server.query_params.EntryListingQueryParams">EntryListingQueryParams</a>, <a class="autorefs autorefs-internal" title="optimade.server.query_params.SingleEntryQueryParams" href="../../query_params/#optimade.server.query_params.SingleEntryQueryParams">SingleEntryQueryParams</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The initialized query parameter model from the server.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="optimade.exceptions.Forbidden" href="../../../exceptions/#optimade.exceptions.Forbidden">Forbidden</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If too large of a page limit is provided.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="optimade.exceptions.BadRequest" href="../../../exceptions/#optimade.exceptions.BadRequest">BadRequest</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an invalid request is made, e.g., with incorrect fields
or response format.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>dict[str, <span title="typing.Any">Any</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary representation of the query parameters.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">handle_query_params</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EntryListingQueryParams</span><span class="p">,</span> <span class="n">SingleEntryQueryParams</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse and interpret the backend-agnostic query parameter models into a dictionary</span>
<span class="sd">    that can be used by the specific backend.</span>

<span class="sd">    Note:</span>
<span class="sd">        Currently this method returns the pymongo interpretation of the parameters,</span>
<span class="sd">        which will need modification for modified for other backends.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        params: The initialized query parameter model from the server.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Forbidden: If too large of a page limit is provided.</span>
<span class="sd">        BadRequest: If an invalid request is made, e.g., with incorrect fields</span>
<span class="sd">            or response format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary representation of the query parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cursor_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># filter</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformer</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">filter</span><span class="p">)</span>  <span class="c1"># type: ignore[union-attr]</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># response_format</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;response_format&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="ow">and</span> <span class="n">params</span><span class="o">.</span><span class="n">response_format</span> <span class="o">!=</span> <span class="s2">&quot;json&quot;</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Response format </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">response_format</span><span class="si">}</span><span class="s2"> is not supported, please use response_format=&#39;json&#39;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># page_limit</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;page_limit&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">page_limit</span>  <span class="c1"># type: ignore[union-attr]</span>
        <span class="k">if</span> <span class="n">limit</span> <span class="o">&gt;</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">page_limit_max</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Forbidden</span><span class="p">(</span>
                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Max allowed page_limit is </span><span class="si">{</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">page_limit_max</span><span class="si">}</span><span class="s2">, you requested </span><span class="si">{</span><span class="n">limit</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">limit</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">page_limit</span>

    <span class="c1"># response_fields</span>
    <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">get_backend_field</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fields</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;response_fields&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">response_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">response_fields</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))</span>
        <span class="n">response_fields</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">get_required_fields</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fields</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_fields</span>

    <span class="c1"># sort</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;sort&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_sort_params</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">sort</span><span class="p">)</span>  <span class="c1"># type: ignore[union-attr]</span>

    <span class="c1"># warn if multiple pagination keys are present, and only use the first from this list</span>
    <span class="n">received_pagination_option</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">warn_multiple_keys</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;page_offset&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">received_pagination_option</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;skip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">page_offset</span>  <span class="c1"># type: ignore[union-attr]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;page_number&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">received_pagination_option</span><span class="p">:</span>
            <span class="n">warn_multiple_keys</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">received_pagination_option</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">page_number</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># type: ignore[union-attr]</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&#39;page_number&#39; is 1-based, using &#39;page_number=1&#39; instead of </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">page_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># type: ignore[union-attr]</span>
                    <span class="n">category</span><span class="o">=</span><span class="n">QueryParamNotUsed</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">page_number</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">page_number</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">page_number</span>  <span class="c1"># type: ignore[union-attr]</span>
            <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;skip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">page_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;limit&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="s2">&quot;page_above&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">received_pagination_option</span><span class="p">:</span>
            <span class="n">warn_multiple_keys</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">received_pagination_option</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cursor_kwargs</span><span class="p">[</span><span class="s2">&quot;page_above&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">page_above</span>  <span class="c1"># type: ignore[union-attr]</span>

    <span class="k">if</span> <span class="n">warn_multiple_keys</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Multiple pagination keys were provided, only using the first one of &#39;page_offset&#39;, &#39;page_number&#39; or &#39;page_above&#39;&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="n">QueryParamNotUsed</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">cursor_kwargs</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.insert" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.insert" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add the given entries to the underlying database.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>data</code></td>
          <td>
                <code>list[<a class="autorefs autorefs-internal" title="optimade.models.EntryResource" href="../../../../all_models/#optimade.models.EntryResource">EntryResource</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The entry resource objects to add to the database.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the given entries to the underlying database.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        data: The entry resource objects to add to the database.</span>

<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.EntryCollection.parse_sort_params" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">parse_sort_params</span><span class="p">(</span><span class="n">sort_params</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.EntryCollection.parse_sort_params" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Handles any sort parameters passed to the collection,
resolving aliases and dealing with any invalid fields.</p>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="optimade.exceptions.BadRequest" href="../../../exceptions/#optimade.exceptions.BadRequest">BadRequest</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>if an invalid sort is requested.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="collections.abc.Iterable">Iterable</span>[tuple[str, int]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of tuples containing the aliased field name and</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code><span title="collections.abc.Iterable">Iterable</span>[tuple[str, int]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>sort direction encoded as 1 (ascending) or -1 (descending).</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_sort_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_params</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles any sort parameters passed to the collection,</span>
<span class="sd">    resolving aliases and dealing with any invalid fields.</span>

<span class="sd">    Raises:</span>
<span class="sd">        BadRequest: if an invalid sort is requested.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of tuples containing the aliased field name and</span>
<span class="sd">        sort direction encoded as 1 (ascending) or -1 (descending).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sort_spec</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">sort_params</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
        <span class="n">sort_dir</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">sort_dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">aliased_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">get_backend_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">sort_spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">aliased_field</span><span class="p">,</span> <span class="n">sort_dir</span><span class="p">))</span>

    <span class="n">unknown_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">field</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sort_spec</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fields</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">unknown_fields</span><span class="p">:</span>
        <span class="n">error_detail</span> <span class="o">=</span> <span class="s2">&quot;Unable to sort on unknown field</span><span class="si">{}</span><span class="s2"> &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&#39;, &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># If all unknown fields are &quot;other&quot; provider-specific, then only provide a warning</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;_[a-z_0-9]+_[a-z_0-9]*&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_prefix</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">unknown_fields</span>
        <span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">error_detail</span><span class="p">,</span> <span class="n">FieldValueNotRecognized</span><span class="p">)</span>

        <span class="c1"># Otherwise, if all fields are unknown, or some fields are unknown and do not</span>
        <span class="c1"># have other provider prefixes, then return 400: Bad Request</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="n">error_detail</span><span class="p">)</span>

    <span class="c1"># If at least one valid field has been provided for sorting, then use that</span>
    <span class="n">sort_spec</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">sort_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">sort_dir</span> <span class="ow">in</span> <span class="n">sort_spec</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unknown_fields</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">sort_spec</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="optimade.server.entry_collections.mongo.EntryListingQueryParams" class="doc doc-heading">
          <code>EntryListingQueryParams</code>


<a href="#optimade.server.entry_collections.mongo.EntryListingQueryParams" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><a class="autorefs autorefs-internal" title="optimade.server.query_params.BaseQueryParams" href="../../query_params/#optimade.server.query_params.BaseQueryParams">BaseQueryParams</a></code></p>

  
      <p>Common query params for all Entry listing endpoints.</p>



  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>filter</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A filter string, in the format described in section API Filtering Format Specification of the specification.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>response_format</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The output format requested (see section Response Format).
Defaults to the format string 'json', which specifies the standard output format described in this specification.</p>
<p><strong>Example</strong>: <code>http://example.com/v1/structures?response_format=xml</code></p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>email_address</code></td>
          <td>
                <code><span title="pydantic.EmailStr">EmailStr</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An email address of the user making the request.
The email SHOULD be that of a person and not an automatic system.</p>
<p><strong>Example</strong>: <code>http://example.com/v1/structures?email_address=user@example.com</code></p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>response_fields</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A comma-delimited set of fields to be provided in the output.
If provided, these fields MUST be returned along with the REQUIRED fields.
Other OPTIONAL fields MUST NOT be returned when this parameter is present.</p>
<p><strong>Example</strong>: <code>http://example.com/v1/structures?response_fields=last_modified,nsites</code></p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>sort</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If supporting sortable queries, an implementation MUST use the <code>sort</code> query parameter with format as specified
by <a href="https://jsonapi.org/format/1.0/#fetching-sorting">JSON API 1.0</a>.</p>
<p>An implementation MAY support multiple sort fields for a single query.
If it does, it again MUST conform to the JSON API 1.0 specification.</p>
<p>If an implementation supports sorting for an entry listing endpoint, then the <code>/info/&lt;entries&gt;</code> endpoint MUST include,
for each field name <code>&lt;fieldname&gt;</code> in its <code>data.properties.&lt;fieldname&gt;</code> response value that can be used for sorting,
the key <code>sortable</code> with value <code>true</code>.
If a field name under an entry listing endpoint supporting sorting cannot be used for sorting, the server MUST either
leave out the <code>sortable</code> key or set it equal to <code>false</code> for the specific field name.
The set of field names, with <code>sortable</code> equal to <code>true</code> are allowed to be used in the "sort fields" list according to
its definition in the JSON API 1.0 specification.
The field <code>sortable</code> is in addition to each property description and other OPTIONAL fields.
An example is shown in the section Entry Listing Info Endpoints.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>page_limit</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Sets a numerical limit on the number of entries returned.
See <a href="https://jsonapi.org/format/1.0/#fetching-pagination">JSON API 1.0</a>.
The API implementation MUST return no more than the number specified.
It MAY return fewer. The database MAY have a maximum limit and not accept larger numbers
(in which case an error code -- <code>403 Forbidden</code> -- MUST be returned).
The default limit value is up to the API implementation to decide.</p>
<p><strong>Example</strong>: <code>http://example.com/optimade/v1/structures?page_limit=100</code></p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>page_offset</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>RECOMMENDED for use with <em>offset-based</em> pagination: using <code>page_offset</code> and <code>page_limit</code> is RECOMMENDED.</p>
<p><strong>Example</strong>: Skip 50 structures and fetch up to 100: <code>/structures?page_offset=50&amp;page_limit=100</code>.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>page_number</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>RECOMMENDED for use with <em>page-based</em> pagination: using <code>page_number</code> and <code>page_limit</code> is RECOMMENDED.
It is RECOMMENDED that the first page has number 1, i.e., that <code>page_number</code> is 1-based.</p>
<p><strong>Example</strong>: Fetch page 2 of up to 50 structures per page: <code>/structures?page_number=2&amp;page_limit=50</code>.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>page_cursor</code></td>
          <td>
                <code>int</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>RECOMMENDED for use with <em>cursor-based</em> pagination: using <code>page_cursor</code> and <code>page_limit</code> is RECOMMENDED.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>page_above</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>RECOMMENDED for use with <em>value-based</em> pagination: using <code>page_above</code>/<code>page_below</code> and <code>page_limit</code> is RECOMMENDED.</p>
<p><strong>Example</strong>: Fetch up to 100 structures above sort-field value 4000 (in this example, server chooses to fetch results sorted by
increasing <code>id</code>, so <code>page_above</code> value refers to an <code>id</code> value): <code>/structures?page_above=4000&amp;page_limit=100</code>.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>page_below</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>RECOMMENDED for use with <em>value-based</em> pagination: using <code>page_above</code>/<code>page_below</code> and <code>page_limit</code> is RECOMMENDED.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>include</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A server MAY implement the JSON API concept of returning <a href="https://jsonapi.org/format/1.0/#document-compound-documents">compound documents</a>
by utilizing the <code>include</code> query parameter as specified by <a href="https://jsonapi.org/format/1.0/#fetching-includes">JSON API 1.0</a>.</p>
<p>All related resource objects MUST be returned as part of an array value for the top-level <code>included</code> field,
see the section JSON Response Schema: Common Fields.</p>
<p>The value of <code>include</code> MUST be a comma-separated list of "relationship paths", as defined in the <a href="https://jsonapi.org/format/1.0/#fetching-includes">JSON API</a>.
If relationship paths are not supported, or a server is unable to identify a relationship path a <code>400 Bad Request</code> response MUST be made.</p>
<p>The <strong>default value</strong> for <code>include</code> is <code>references</code>. This means <code>references</code> entries MUST always be included under the top-level field
<code>included</code> as default, since a server assumes if <code>include</code> is not specified by a client in the request, it is still specified as <code>include=references</code>.
Note, if a client explicitly specifies <code>include</code> and leaves out <code>references</code>, <code>references</code> resource objects MUST NOT be included under the top-level
field <code>included</code>, as per the definition of <code>included</code>, see section JSON Response Schema: Common Fields.</p>
<p><strong>Note</strong>: A query with the parameter <code>include</code> set to the empty string means no related resource objects are to be returned under the top-level field <code>included</code>.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>api_hint</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If the client provides the parameter, the value SHOULD have the format <code>vMAJOR</code> or <code>vMAJOR.MINOR</code>,
where MAJOR is a major version and MINOR is a minor version of the API.
For example, if a client appends <code>api_hint=v1.0</code> to the query string, the hint provided is for major version 1 and minor version 0.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

            <details class="quote">
              <summary>Source code in <code>optimade/server/query_params.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">EntryListingQueryParams</span><span class="p">(</span><span class="n">BaseQueryParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common query params for all Entry listing endpoints.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        filter (str): A filter string, in the format described in section API Filtering Format Specification of the specification.</span>

<span class="sd">        response_format (str): The output format requested (see section Response Format).</span>
<span class="sd">            Defaults to the format string &#39;json&#39;, which specifies the standard output format described in this specification.</span>

<span class="sd">            **Example**: `http://example.com/v1/structures?response_format=xml`</span>

<span class="sd">        email_address (EmailStr): An email address of the user making the request.</span>
<span class="sd">            The email SHOULD be that of a person and not an automatic system.</span>

<span class="sd">            **Example**: `http://example.com/v1/structures?email_address=user@example.com`</span>

<span class="sd">        response_fields (str): A comma-delimited set of fields to be provided in the output.</span>
<span class="sd">            If provided, these fields MUST be returned along with the REQUIRED fields.</span>
<span class="sd">            Other OPTIONAL fields MUST NOT be returned when this parameter is present.</span>

<span class="sd">            **Example**: `http://example.com/v1/structures?response_fields=last_modified,nsites`</span>

<span class="sd">        sort (str): If supporting sortable queries, an implementation MUST use the `sort` query parameter with format as specified</span>
<span class="sd">            by [JSON API 1.0](https://jsonapi.org/format/1.0/#fetching-sorting).</span>

<span class="sd">            An implementation MAY support multiple sort fields for a single query.</span>
<span class="sd">            If it does, it again MUST conform to the JSON API 1.0 specification.</span>

<span class="sd">            If an implementation supports sorting for an entry listing endpoint, then the `/info/&lt;entries&gt;` endpoint MUST include,</span>
<span class="sd">            for each field name `&lt;fieldname&gt;` in its `data.properties.&lt;fieldname&gt;` response value that can be used for sorting,</span>
<span class="sd">            the key `sortable` with value `true`.</span>
<span class="sd">            If a field name under an entry listing endpoint supporting sorting cannot be used for sorting, the server MUST either</span>
<span class="sd">            leave out the `sortable` key or set it equal to `false` for the specific field name.</span>
<span class="sd">            The set of field names, with `sortable` equal to `true` are allowed to be used in the &quot;sort fields&quot; list according to</span>
<span class="sd">            its definition in the JSON API 1.0 specification.</span>
<span class="sd">            The field `sortable` is in addition to each property description and other OPTIONAL fields.</span>
<span class="sd">            An example is shown in the section Entry Listing Info Endpoints.</span>

<span class="sd">        page_limit (int): Sets a numerical limit on the number of entries returned.</span>
<span class="sd">            See [JSON API 1.0](https://jsonapi.org/format/1.0/#fetching-pagination).</span>
<span class="sd">            The API implementation MUST return no more than the number specified.</span>
<span class="sd">            It MAY return fewer. The database MAY have a maximum limit and not accept larger numbers</span>
<span class="sd">            (in which case an error code -- `403 Forbidden` -- MUST be returned).</span>
<span class="sd">            The default limit value is up to the API implementation to decide.</span>

<span class="sd">            **Example**: `http://example.com/optimade/v1/structures?page_limit=100`</span>

<span class="sd">        page_offset (int): RECOMMENDED for use with _offset-based_ pagination: using `page_offset` and `page_limit` is RECOMMENDED.</span>

<span class="sd">            **Example**: Skip 50 structures and fetch up to 100: `/structures?page_offset=50&amp;page_limit=100`.</span>

<span class="sd">        page_number (int): RECOMMENDED for use with _page-based_ pagination: using `page_number` and `page_limit` is RECOMMENDED.</span>
<span class="sd">            It is RECOMMENDED that the first page has number 1, i.e., that `page_number` is 1-based.</span>

<span class="sd">            **Example**: Fetch page 2 of up to 50 structures per page: `/structures?page_number=2&amp;page_limit=50`.</span>

<span class="sd">        page_cursor (int): RECOMMENDED for use with _cursor-based_ pagination: using `page_cursor` and `page_limit` is RECOMMENDED.</span>

<span class="sd">        page_above (str): RECOMMENDED for use with _value-based_ pagination: using `page_above`/`page_below` and `page_limit` is RECOMMENDED.</span>

<span class="sd">            **Example**: Fetch up to 100 structures above sort-field value 4000 (in this example, server chooses to fetch results sorted by</span>
<span class="sd">            increasing `id`, so `page_above` value refers to an `id` value): `/structures?page_above=4000&amp;page_limit=100`.</span>

<span class="sd">        page_below (str): RECOMMENDED for use with _value-based_ pagination: using `page_above`/`page_below` and `page_limit` is RECOMMENDED.</span>

<span class="sd">        include (str): A server MAY implement the JSON API concept of returning [compound documents](https://jsonapi.org/format/1.0/#document-compound-documents)</span>
<span class="sd">            by utilizing the `include` query parameter as specified by [JSON API 1.0](https://jsonapi.org/format/1.0/#fetching-includes).</span>

<span class="sd">            All related resource objects MUST be returned as part of an array value for the top-level `included` field,</span>
<span class="sd">            see the section JSON Response Schema: Common Fields.</span>

<span class="sd">            The value of `include` MUST be a comma-separated list of &quot;relationship paths&quot;, as defined in the [JSON API](https://jsonapi.org/format/1.0/#fetching-includes).</span>
<span class="sd">            If relationship paths are not supported, or a server is unable to identify a relationship path a `400 Bad Request` response MUST be made.</span>

<span class="sd">            The **default value** for `include` is `references`. This means `references` entries MUST always be included under the top-level field</span>
<span class="sd">            `included` as default, since a server assumes if `include` is not specified by a client in the request, it is still specified as `include=references`.</span>
<span class="sd">            Note, if a client explicitly specifies `include` and leaves out `references`, `references` resource objects MUST NOT be included under the top-level</span>
<span class="sd">            field `included`, as per the definition of `included`, see section JSON Response Schema: Common Fields.</span>

<span class="sd">            **Note**: A query with the parameter `include` set to the empty string means no related resource objects are to be returned under the top-level field `included`.</span>

<span class="sd">        api_hint (str): If the client provides the parameter, the value SHOULD have the format `vMAJOR` or `vMAJOR.MINOR`,</span>
<span class="sd">            where MAJOR is a major version and MINOR is a minor version of the API.</span>
<span class="sd">            For example, if a client appends `api_hint=v1.0` to the query string, the hint provided is for major version 1 and minor version 0.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The reference server implementation only supports offset/number-based pagination</span>
    <span class="n">unsupported_params</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;page_cursor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;page_below&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>  <span class="c1"># pylint: disable=redefined-builtin</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A filter string, in the format described in section API Filtering Format Specification of the specification.&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">response_format</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The output format requested (see section Response Format).</span><span class="se">\n</span><span class="s2">Defaults to the format string &#39;json&#39;, which specifies the standard output format described in this specification.</span><span class="se">\n</span><span class="s2">Example: `http://example.com/v1/structures?response_format=xml`&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="n">email_address</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="n">EmailStr</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;An email address of the user making the request.</span><span class="se">\n</span><span class="s2">The email SHOULD be that of a person and not an automatic system.</span><span class="se">\n</span><span class="s2">Example: `http://example.com/v1/structures?email_address=user@example.com`&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">response_fields</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A comma-delimited set of fields to be provided in the output.</span><span class="se">\n</span><span class="s2">If provided, these fields MUST be returned along with the REQUIRED fields.</span><span class="se">\n</span><span class="s2">Other OPTIONAL fields MUST NOT be returned when this parameter is present.</span><span class="se">\n</span><span class="s2">Example: `http://example.com/v1/structures?response_fields=last_modified,nsites`&quot;</span><span class="p">,</span>
                <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;([a-z_][a-z_0-9]*(,[a-z_][a-z_0-9]*)*)?&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">sort</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;If supporting sortable queries, an implementation MUST use the `sort` query parameter with format as specified by [JSON API 1.0](https://jsonapi.org/format/1.0/#fetching-sorting).</span><span class="se">\n\n</span><span class="s1">An implementation MAY support multiple sort fields for a single query.</span><span class="se">\n</span><span class="s1">If it does, it again MUST conform to the JSON API 1.0 specification.</span><span class="se">\n\n</span><span class="s1">If an implementation supports sorting for an entry listing endpoint, then the `/info/&lt;entries&gt;` endpoint MUST include, for each field name `&lt;fieldname&gt;` in its `data.properties.&lt;fieldname&gt;` response value that can be used for sorting, the key `sortable` with value `true`.</span><span class="se">\n</span><span class="s1">If a field name under an entry listing endpoint supporting sorting cannot be used for sorting, the server MUST either leave out the `sortable` key or set it equal to `false` for the specific field name.</span><span class="se">\n</span><span class="s1">The set of field names, with `sortable` equal to `true` are allowed to be used in the &quot;sort fields&quot; list according to its definition in the JSON API 1.0 specification.</span><span class="se">\n</span><span class="s1">The field `sortable` is in addition to each property description and other OPTIONAL fields.</span><span class="se">\n</span><span class="s1">An example is shown in the section Entry Listing Info Endpoints.&#39;</span><span class="p">,</span>
                <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;([a-z_][a-z_0-9]*(,[a-z_][a-z_0-9]*)*)?&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">page_limit</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">int</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Sets a numerical limit on the number of entries returned.</span><span class="se">\n</span><span class="s2">See [JSON API 1.0](https://jsonapi.org/format/1.0/#fetching-pagination).</span><span class="se">\n</span><span class="s2">The API implementation MUST return no more than the number specified.</span><span class="se">\n</span><span class="s2">It MAY return fewer.</span><span class="se">\n</span><span class="s2">The database MAY have a maximum limit and not accept larger numbers (in which case an error code -- 403 Forbidden -- MUST be returned).</span><span class="se">\n</span><span class="s2">The default limit value is up to the API implementation to decide.</span><span class="se">\n</span><span class="s2">Example: `http://example.com/optimade/v1/structures?page_limit=100`&quot;</span><span class="p">,</span>
                <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">page_limit</span><span class="p">,</span>
        <span class="n">page_offset</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">int</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;RECOMMENDED for use with _offset-based_ pagination: using `page_offset` and `page_limit` is RECOMMENDED.</span><span class="se">\n</span><span class="s2">Example: Skip 50 structures and fetch up to 100: `/structures?page_offset=50&amp;page_limit=100`.&quot;</span><span class="p">,</span>
                <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">page_number</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">int</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;RECOMMENDED for use with _page-based_ pagination: using `page_number` and `page_limit` is RECOMMENDED.</span><span class="se">\n</span><span class="s2">It is RECOMMENDED that the first page has number 1, i.e., that `page_number` is 1-based.</span><span class="se">\n</span><span class="s2">Example: Fetch page 2 of up to 50 structures per page: `/structures?page_number=2&amp;page_limit=50`.&quot;</span><span class="p">,</span>
                <span class="c1"># ge=1,  # This constraint is only &#39;RECOMMENDED&#39; in the specification, so should not be included here or in the OpenAPI schema</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore[assignment]</span>
        <span class="n">page_cursor</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">int</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;RECOMMENDED for use with _cursor-based_ pagination: using `page_cursor` and `page_limit` is RECOMMENDED.&quot;</span><span class="p">,</span>
                <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">page_above</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;RECOMMENDED for use with _value-based_ pagination: using `page_above`/`page_below` and `page_limit` is RECOMMENDED.</span><span class="se">\n</span><span class="s2">Example: Fetch up to 100 structures above sort-field value 4000 (in this example, server chooses to fetch results sorted by increasing `id`, so `page_above` value refers to an `id` value): `/structures?page_above=4000&amp;page_limit=100`.&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore[assignment]</span>
        <span class="n">page_below</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;RECOMMENDED for use with _value-based_ pagination: using `page_above`/`page_below` and `page_limit` is RECOMMENDED.&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># type: ignore[assignment]</span>
        <span class="n">include</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A server MAY implement the JSON API concept of returning [compound documents](https://jsonapi.org/format/1.0/#document-compound-documents) by utilizing the `include` query parameter as specified by [JSON API 1.0](https://jsonapi.org/format/1.0/#fetching-includes).</span><span class="se">\n\n</span><span class="s1">All related resource objects MUST be returned as part of an array value for the top-level `included` field, see the section JSON Response Schema: Common Fields.</span><span class="se">\n\n</span><span class="s1">The value of `include` MUST be a comma-separated list of &quot;relationship paths&quot;, as defined in the [JSON API](https://jsonapi.org/format/1.0/#fetching-includes).</span><span class="se">\n</span><span class="s1">If relationship paths are not supported, or a server is unable to identify a relationship path a `400 Bad Request` response MUST be made.</span><span class="se">\n\n</span><span class="s1">The **default value** for `include` is `references`.</span><span class="se">\n</span><span class="s1">This means `references` entries MUST always be included under the top-level field `included` as default, since a server assumes if `include` is not specified by a client in the request, it is still specified as `include=references`.</span><span class="se">\n</span><span class="s1">Note, if a client explicitly specifies `include` and leaves out `references`, `references` resource objects MUST NOT be included under the top-level field `included`, as per the definition of `included`, see section JSON Response Schema: Common Fields.</span><span class="se">\n\n</span><span class="s1">&gt; **Note**: A query with the parameter `include` set to the empty string means no related resource objects are to be returned under the top-level field `included`.&#39;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;references&quot;</span><span class="p">,</span>
        <span class="n">api_hint</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If the client provides the parameter, the value SHOULD have the format `vMAJOR` or `vMAJOR.MINOR`, where MAJOR is a major version and MINOR is a minor version of the API. For example, if a client appends `api_hint=v1.0` to the query string, the hint provided is for major version 1 and minor version 0.&quot;</span><span class="p">,</span>
                <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;(v[0-9]+(\.[0-9]+)?)?&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="nb">filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_format</span> <span class="o">=</span> <span class="n">response_format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_address</span> <span class="o">=</span> <span class="n">email_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_fields</span> <span class="o">=</span> <span class="n">response_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sort</span> <span class="o">=</span> <span class="n">sort</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_limit</span> <span class="o">=</span> <span class="n">page_limit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_offset</span> <span class="o">=</span> <span class="n">page_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_number</span> <span class="o">=</span> <span class="n">page_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_cursor</span> <span class="o">=</span> <span class="n">page_cursor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_above</span> <span class="o">=</span> <span class="n">page_above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">page_below</span> <span class="o">=</span> <span class="n">page_below</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="n">include</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_hint</span> <span class="o">=</span> <span class="n">api_hint</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.EntryListingQueryParams.check_params" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">check_params</span><span class="p">(</span><span class="n">query_params</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.EntryListingQueryParams.check_params" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>This method checks whether all the query parameters that are specified
in the URL string are implemented in the relevant <code>*QueryParams</code> class.</p>
<p>This method handles four cases:</p>
<ul>
<li>If a query parameter is passed that is not defined in the relevant <code>*QueryParams</code> class,
  and it is not prefixed with a known provider prefix, then a <code>BadRequest</code> is raised.</li>
<li>If a query parameter is passed that is not defined in the relevant <code>*QueryParams</code> class,
  that is prefixed with a known provider prefix, then the parameter is silently ignored</li>
<li>If a query parameter is passed that is not defined in the relevant <code>*QueryParams</code> class,
  that is prefixed with an unknown provider prefix, then a <code>UnknownProviderQueryParameter</code>
  warning is emitted.</li>
<li>If a query parameter is passed that is on the <code>unsupported_params</code> list for the inherited
  class, then a <code>QueryParamNotUsed</code> warning is emitted.</li>
</ul>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>query_params</code></td>
          <td>
                <code><span title="collections.abc.Iterable">Iterable</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An iterable of the request's string query parameters.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>`BadRequest`</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>if the query parameter was not found in the relevant class, or if it
does not have a valid prefix.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/query_params.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">check_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_params</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method checks whether all the query parameters that are specified</span>
<span class="sd">    in the URL string are implemented in the relevant `*QueryParams` class.</span>

<span class="sd">    This method handles four cases:</span>

<span class="sd">    * If a query parameter is passed that is not defined in the relevant `*QueryParams` class,</span>
<span class="sd">      and it is not prefixed with a known provider prefix, then a `BadRequest` is raised.</span>
<span class="sd">    * If a query parameter is passed that is not defined in the relevant `*QueryParams` class,</span>
<span class="sd">      that is prefixed with a known provider prefix, then the parameter is silently ignored</span>
<span class="sd">    * If a query parameter is passed that is not defined in the relevant `*QueryParams` class,</span>
<span class="sd">      that is prefixed with an unknown provider prefix, then a `UnknownProviderQueryParameter`</span>
<span class="sd">      warning is emitted.</span>
<span class="sd">    * If a query parameter is passed that is on the `unsupported_params` list for the inherited</span>
<span class="sd">      class, then a `QueryParamNotUsed` warning is emitted.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        query_params: An iterable of the request&#39;s string query parameters.</span>

<span class="sd">    Raises:</span>
<span class="sd">        `BadRequest`: if the query parameter was not found in the relevant class, or if it</span>
<span class="sd">            does not have a valid prefix.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">,</span> <span class="s2">&quot;validate_query_parameters&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unsupported_warnings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">query_params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsupported_params</span><span class="p">:</span>
            <span class="n">unsupported_warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
            <span class="n">split_param</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_param</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">split_param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">BaseResourceMapper</span><span class="o">.</span><span class="n">SUPPORTED_PREFIXES</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BaseResourceMapper</span><span class="o">.</span><span class="n">KNOWN_PROVIDER_PREFIXES</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">warnings</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The query parameter(s) &#39;</span><span class="si">{</span><span class="n">warnings</span><span class="si">}</span><span class="s2">&#39; are unrecognised and have been ignored.&quot;</span><span class="p">,</span>
            <span class="n">UnknownProviderQueryParameter</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">unsupported_warnings</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The query parameter(s) &#39;</span><span class="si">{</span><span class="n">unsupported_warnings</span><span class="si">}</span><span class="s2">&#39; are not supported by this server and have been ignored.&quot;</span><span class="p">,</span>
            <span class="n">QueryParamNotUsed</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The query parameter(s) &#39;</span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&#39; are not recognised by this endpoint.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="optimade.server.entry_collections.mongo.EntryResource" class="doc doc-heading">
          <code>EntryResource</code>


<a href="#optimade.server.entry_collections.mongo.EntryResource" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><a class="autorefs autorefs-internal" title="optimade.models.jsonapi.Resource" href="../../../models/jsonapi/#optimade.models.jsonapi.Resource">Resource</a></code></p>

  
      <p>The base model for an entry resource.</p>

            <details class="quote">
              <summary>Source code in <code>optimade/models/entries.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">EntryResource</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The base model for an entry resource.&quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="n">OptimadeField</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;An entry&#39;s ID as defined in section Definition of Terms.</span>

<span class="s2">- **Type**: string.</span>

<span class="s2">- **Requirements/Conventions**:</span>
<span class="s2">    - **Support**: MUST be supported by all implementations, MUST NOT be `null`.</span>
<span class="s2">    - **Query**: MUST be a queryable property with support for all mandatory filter features.</span>
<span class="s2">    - **Response**: REQUIRED in the response.</span>

<span class="s2">- **Examples**:</span>
<span class="s2">    - `&quot;db/1234567&quot;`</span>
<span class="s2">    - `&quot;cod/2000000&quot;`</span>
<span class="s2">    - `&quot;cod/2000000@1234567&quot;`</span>
<span class="s2">    - `&quot;nomad/L1234567890&quot;`</span>
<span class="s2">    - `&quot;42&quot;`&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">support</span><span class="o">=</span><span class="n">SupportLevel</span><span class="o">.</span><span class="n">MUST</span><span class="p">,</span>
            <span class="n">queryable</span><span class="o">=</span><span class="n">SupportLevel</span><span class="o">.</span><span class="n">MUST</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
        <span class="nb">str</span><span class="p">,</span>
        <span class="n">OptimadeField</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;The name of the type of an entry.</span>

<span class="s2">- **Type**: string.</span>

<span class="s2">- **Requirements/Conventions**:</span>
<span class="s2">    - **Support**: MUST be supported by all implementations, MUST NOT be `null`.</span>
<span class="s2">    - **Query**: MUST be a queryable property with support for all mandatory filter features.</span>
<span class="s2">    - **Response**: REQUIRED in the response.</span>
<span class="s2">    - MUST be an existing entry type.</span>
<span class="s2">    - The entry of type `&lt;type&gt;` and ID `&lt;id&gt;` MUST be returned in response to a request for `/&lt;type&gt;/&lt;id&gt;` under the versioned base URL.</span>

<span class="s2">- **Example**: `&quot;structures&quot;`&quot;&quot;&quot;</span><span class="p">,</span>
            <span class="n">support</span><span class="o">=</span><span class="n">SupportLevel</span><span class="o">.</span><span class="n">MUST</span><span class="p">,</span>
            <span class="n">queryable</span><span class="o">=</span><span class="n">SupportLevel</span><span class="o">.</span><span class="n">MUST</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="n">attributes</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
        <span class="n">EntryResourceAttributes</span><span class="p">,</span>
        <span class="n">StrictField</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;A dictionary, containing key-value pairs representing the entry&#39;s properties, except for `type` and `id`.</span>
<span class="s2">Database-provider-specific properties need to include the database-provider-specific prefix (see section on Database-Provider-Specific Namespace Prefixes).&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="n">relationships</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
        <span class="n">Optional</span><span class="p">[</span><span class="n">EntryRelationships</span><span class="p">],</span>
        <span class="n">StrictField</span><span class="p">(</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;A dictionary containing references to other entries according to the description in section Relationships encoded as [JSON API Relationships](https://jsonapi.org/format/1.0/#document-resource-object-relationships).</span>
<span class="s2">The OPTIONAL human-readable description of the relationship MAY be provided in the `description` field inside the `meta` dictionary of the JSON API resource identifier object.&quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="optimade.server.entry_collections.mongo.MongoCollection" class="doc doc-heading">
          <code>MongoCollection</code>


<a href="#optimade.server.entry_collections.mongo.MongoCollection" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><a class="autorefs autorefs-internal" title="optimade.server.entry_collections.EntryCollection" href="../entry_collections/#optimade.server.entry_collections.entry_collections.EntryCollection">EntryCollection</a></code></p>

  
      <p>Class for querying MongoDB collections (implemented by either pymongo or mongomock)
containing serialized <a class="autorefs autorefs-internal" href="../../../models/entries/#optimade.models.entries.EntryResource"><code>EntryResource</code></a>s objects.</p>

            <details class="quote">
              <summary>Source code in <code>optimade/server/entry_collections/mongo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MongoCollection</span><span class="p">(</span><span class="n">EntryCollection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for querying MongoDB collections (implemented by either pymongo or mongomock)</span>
<span class="sd">    containing serialized [`EntryResource`][optimade.models.entries.EntryResource]s objects.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">resource_cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">],</span>
        <span class="n">resource_mapper</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseResourceMapper</span><span class="p">],</span>
        <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">mongo_database</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the MongoCollection for the given parameters.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            name: The name of the collection.</span>
<span class="sd">            resource_cls: The type of entry resource that is stored by the collection.</span>
<span class="sd">            resource_mapper: A resource mapper object that handles aliases and</span>
<span class="sd">                format changes between deserialization and response.</span>
<span class="sd">            database: The name of the underlying MongoDB database to connect to.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">resource_cls</span><span class="p">,</span>
            <span class="n">resource_mapper</span><span class="p">,</span>
            <span class="n">MongoTransformer</span><span class="p">(</span><span class="n">mapper</span><span class="o">=</span><span class="n">resource_mapper</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">CLIENT</span><span class="p">[</span><span class="n">database</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># check aliases do not clash with mongo operators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_aliases</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">all_aliases</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_aliases</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">all_length_aliases</span><span class="p">())</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the total number of entries in the collection.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">estimated_document_count</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the number of entries matching the query specified</span>
<span class="sd">        by the keyword arguments, or `None` if the count timed out.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            **kwargs: Query parameters as keyword arguments. The keys</span>
<span class="sd">                &#39;filter&#39;, &#39;skip&#39;, &#39;limit&#39;, &#39;hint&#39; and &#39;maxTimeMS&#39; will be passed</span>
<span class="sd">                to the `pymongo.collection.Collection.count_documents` method.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="s2">&quot;hint&quot;</span><span class="p">,</span> <span class="s2">&quot;maxTimeMS&quot;</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">estimated_document_count</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;maxTimeMS&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;maxTimeMS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">mongo_count_timeout</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ExecutionTimeout</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the given entries to the underlying database.</span>

<span class="sd">        Warning:</span>
<span class="sd">            No validation is performed on the incoming data.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            data: The entry resource objects to add to the database.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_query_params</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EntryListingQueryParams</span><span class="p">,</span> <span class="n">SingleEntryQueryParams</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse and interpret the backend-agnostic query parameter models into a dictionary</span>
<span class="sd">        that can be used by MongoDB.</span>

<span class="sd">        This Mongo-specific method calls the base `EntryCollection.handle_query_params` method</span>
<span class="sd">        and adds additional handling of the MongoDB ObjectID type.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            params: The initialized query parameter model from the server.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Forbidden: If too large of a page limit is provided.</span>
<span class="sd">            BadRequest: If an invalid request is made, e.g., with incorrect fields</span>
<span class="sd">                or response format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary representation of the query parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">criteria</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">handle_query_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># Handle MongoDB ObjectIDs:</span>
        <span class="c1"># - If they were not requested, then explicitly remove them</span>
        <span class="c1"># - If they were requested, then cast them to strings in the response</span>
        <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="p">{}):</span>
            <span class="n">criteria</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">][</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="s2">&quot;page_above&quot;</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                <span class="s2">&quot;`page_above` is not implemented for this backend.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">):</span>
            <span class="n">criteria</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">][</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$toString&quot;</span><span class="p">:</span> <span class="s2">&quot;$_id&quot;</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">criteria</span>

    <span class="k">def</span> <span class="nf">_run_db_query</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">criteria</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">single_entry</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the query on the backend and collect the results.</span>

<span class="sd">        Arguments:</span>
<span class="sd">            criteria: A dictionary representation of the query parameters.</span>
<span class="sd">            single_entry: Whether or not the caller is expecting a single entry response.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of entries from the database (without any re-mapping), the total number of</span>
<span class="sd">            entries matching the query and a boolean for whether or not there is more data available.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="o">**</span><span class="n">criteria</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">database_backend</span> <span class="o">==</span> <span class="n">SupportedBackend</span><span class="o">.</span><span class="n">MONGOMOCK</span> <span class="ow">and</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="p">{}</span>
        <span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">):</span>
            <span class="c1"># mongomock does not support `$toString`` in projection, so we have to do it manually</span>
            <span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">doc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
                <span class="n">results</span><span class="p">[</span><span class="n">ind</span><span class="p">][</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">doc</span><span class="p">[</span><span class="s2">&quot;_id&quot;</span><span class="p">])</span>

        <span class="n">nresults_now</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">single_entry</span><span class="p">:</span>
            <span class="n">criteria_nolimit</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">criteria_nolimit</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">skip</span> <span class="o">=</span> <span class="n">criteria_nolimit</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">data_returned</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="o">**</span><span class="n">criteria_nolimit</span><span class="p">)</span>
            <span class="c1"># Only correct most of the time: if the total number of remaining results is exactly the page limit</span>
            <span class="c1"># then this will incorrectly say there is more_data_available</span>
            <span class="k">if</span> <span class="n">data_returned</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">more_data_available</span> <span class="o">=</span> <span class="n">nresults_now</span> <span class="o">==</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">more_data_available</span> <span class="o">=</span> <span class="n">nresults_now</span> <span class="o">+</span> <span class="n">skip</span> <span class="o">&lt;</span> <span class="n">data_returned</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># SingleEntryQueryParams, e.g., /structures/{entry_id}</span>
            <span class="n">data_returned</span> <span class="o">=</span> <span class="n">nresults_now</span>
            <span class="n">more_data_available</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">data_returned</span><span class="p">,</span> <span class="n">more_data_available</span>

    <span class="k">def</span> <span class="nf">_check_aliases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aliases</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check that aliases do not clash with mongo keywords.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">alias</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">alias</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;$&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot define an alias starting with a &#39;$&#39;: </span><span class="si">{</span><span class="n">aliases</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.all_fields" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">all_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.all_fields" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Get the set of all fields handled in this collection,
from attribute fields in the schema, provider fields and top-level OPTIMADE fields.</p>
<p>The set of all fields are lazily created and then cached.
This means the set is created the first time the property is requested and then cached.</p>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>set[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>All fields handled in this collection.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.pagination_mechanism" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">pagination_mechanism</span> <span class="o">=</span> <span class="n">PaginationMechanism</span><span class="p">(</span><span class="s1">&#39;page_offset&#39;</span><span class="p">)</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.pagination_mechanism" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>The default pagination mechansim to use with a given collection,
if the user does not provide any pagination query parameters.</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">resource_cls</span><span class="p">,</span> <span class="n">resource_mapper</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="n">CONFIG</span><span class="o">.</span><span class="n">mongo_database</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Initialize the MongoCollection for the given parameters.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>name</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the collection.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>resource_cls</code></td>
          <td>
                <code>type[<a class="autorefs autorefs-internal" title="optimade.models.EntryResource" href="../../../../all_models/#optimade.models.EntryResource">EntryResource</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The type of entry resource that is stored by the collection.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>resource_mapper</code></td>
          <td>
                <code>type[<a class="autorefs autorefs-internal" title="optimade.server.mappers.BaseResourceMapper" href="../../mappers/entries/#optimade.server.mappers.entries.BaseResourceMapper">BaseResourceMapper</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A resource mapper object that handles aliases and
format changes between deserialization and response.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>database</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The name of the underlying MongoDB database to connect to.</p>
            </div>
          </td>
          <td>
                <code><span title="optimade.server.config.CONFIG.mongo_database">mongo_database</span></code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/mongo.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">resource_cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">],</span>
    <span class="n">resource_mapper</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BaseResourceMapper</span><span class="p">],</span>
    <span class="n">database</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">mongo_database</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the MongoCollection for the given parameters.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        name: The name of the collection.</span>
<span class="sd">        resource_cls: The type of entry resource that is stored by the collection.</span>
<span class="sd">        resource_mapper: A resource mapper object that handles aliases and</span>
<span class="sd">            format changes between deserialization and response.</span>
<span class="sd">        database: The name of the underlying MongoDB database to connect to.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">resource_cls</span><span class="p">,</span>
        <span class="n">resource_mapper</span><span class="p">,</span>
        <span class="n">MongoTransformer</span><span class="p">(</span><span class="n">mapper</span><span class="o">=</span><span class="n">resource_mapper</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">collection</span> <span class="o">=</span> <span class="n">CLIENT</span><span class="p">[</span><span class="n">database</span><span class="p">][</span><span class="n">name</span><span class="p">]</span>

    <span class="c1"># check aliases do not clash with mongo operators</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_check_aliases</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">all_aliases</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_check_aliases</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">all_length_aliases</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.__len__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__len__</span><span class="p">()</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.__len__" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns the total number of entries in the collection.</p>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/mongo.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the total number of entries in the collection.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">estimated_document_count</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.count" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">count</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.count" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Returns the number of entries matching the query specified
by the keyword arguments, or <code>None</code> if the count timed out.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>**kwargs</code></td>
          <td>
                <code><span title="typing.Any">Any</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Query parameters as keyword arguments. The keys
'filter', 'skip', 'limit', 'hint' and 'maxTimeMS' will be passed
to the <code>pymongo.collection.Collection.count_documents</code> method.</p>
            </div>
          </td>
          <td>
                <code>{}</code>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/mongo.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the number of entries matching the query specified</span>
<span class="sd">    by the keyword arguments, or `None` if the count timed out.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        **kwargs: Query parameters as keyword arguments. The keys</span>
<span class="sd">            &#39;filter&#39;, &#39;skip&#39;, &#39;limit&#39;, &#39;hint&#39; and &#39;maxTimeMS&#39; will be passed</span>
<span class="sd">            to the `pymongo.collection.Collection.count_documents` method.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="s2">&quot;skip&quot;</span><span class="p">,</span> <span class="s2">&quot;limit&quot;</span><span class="p">,</span> <span class="s2">&quot;hint&quot;</span><span class="p">,</span> <span class="s2">&quot;maxTimeMS&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;filter&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">estimated_document_count</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;maxTimeMS&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;maxTimeMS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="n">CONFIG</span><span class="o">.</span><span class="n">mongo_count_timeout</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">count_documents</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ExecutionTimeout</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.find" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.find" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Fetches results and indicates if more data is available.</p>
<p>Also gives the total number of data available in the absence of <code>page_limit</code>.
See <a class="autorefs autorefs-internal" href="../../query_params/#optimade.server.query_params.EntryListingQueryParams"><code>EntryListingQueryParams</code></a>
for more information.</p>
<p>Returns a list of the mapped database reponse.</p>
<p>If no results match the query, then <code>results</code> is set to <code>None</code>.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="optimade.server.query_params.EntryListingQueryParams" href="../../query_params/#optimade.server.query_params.EntryListingQueryParams">EntryListingQueryParams</a>, <a class="autorefs autorefs-internal" title="optimade.server.query_params.SingleEntryQueryParams" href="../../query_params/#optimade.server.query_params.SingleEntryQueryParams">SingleEntryQueryParams</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Entry listing URL query params.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[dict[str, <span title="typing.Any">Any</span>], list[dict[str, <span title="typing.Any">Any</span>]]]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A tuple of various relevant values:</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code><span title="typing.Optional">Optional</span>[int]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>(<code>results</code>, <code>data_returned</code>, <code>more_data_available</code>, <code>exclude_fields</code>, <code>include_fields</code>).</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">find</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EntryListingQueryParams</span><span class="p">,</span> <span class="n">SingleEntryQueryParams</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
    <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]],</span>
    <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="nb">bool</span><span class="p">,</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fetches results and indicates if more data is available.</span>

<span class="sd">    Also gives the total number of data available in the absence of `page_limit`.</span>
<span class="sd">    See [`EntryListingQueryParams`][optimade.server.query_params.EntryListingQueryParams]</span>
<span class="sd">    for more information.</span>

<span class="sd">    Returns a list of the mapped database reponse.</span>

<span class="sd">    If no results match the query, then `results` is set to `None`.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        params: Entry listing URL query params.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of various relevant values:</span>
<span class="sd">        (`results`, `data_returned`, `more_data_available`, `exclude_fields`, `include_fields`).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_query_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">single_entry</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">SingleEntryQueryParams</span><span class="p">)</span>
    <span class="n">response_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">criteria</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fields&quot;</span><span class="p">)</span>

    <span class="n">raw_results</span><span class="p">,</span> <span class="n">data_returned</span><span class="p">,</span> <span class="n">more_data_available</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_db_query</span><span class="p">(</span>
        <span class="n">criteria</span><span class="p">,</span> <span class="n">single_entry</span>
    <span class="p">)</span>

    <span class="n">exclude_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fields</span> <span class="o">-</span> <span class="n">response_fields</span>
    <span class="n">include_fields</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">response_fields</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">TOP_LEVEL_NON_ATTRIBUTES_FIELDS</span>
    <span class="p">)</span>

    <span class="n">bad_optimade_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">bad_provider_fields</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">supported_prefixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">SUPPORTED_PREFIXES</span>
    <span class="n">all_attributes</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">ALL_ATTRIBUTES</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">include_fields</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_attributes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">any</span><span class="p">(</span>
                    <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">supported_prefixes</span>
                <span class="p">):</span>
                    <span class="n">bad_provider_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bad_optimade_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bad_provider_fields</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unrecognised field(s) for this provider requested in `response_fields`: </span><span class="si">{</span><span class="n">bad_provider_fields</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="n">UnknownProviderProperty</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">bad_optimade_fields</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span>
            <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Unrecognised OPTIMADE field(s) in requested `response_fields`: </span><span class="si">{</span><span class="n">bad_optimade_fields</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

    <span class="n">results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">raw_results</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">map_back</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">raw_results</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">single_entry</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">CONFIG</span><span class="o">.</span><span class="n">validate_api_response</span>
                <span class="ow">and</span> <span class="n">data_returned</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">data_returned</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">NotFound</span><span class="p">(</span>
                    <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Instead of a single entry, </span><span class="si">{</span><span class="n">data_returned</span><span class="si">}</span><span class="s2"> entries were found&quot;</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data_returned</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">results</span><span class="p">,</span>
        <span class="n">data_returned</span><span class="p">,</span>
        <span class="n">more_data_available</span><span class="p">,</span>
        <span class="n">exclude_fields</span><span class="p">,</span>
        <span class="n">include_fields</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.get_attribute_fields" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_attribute_fields</span><span class="p">()</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.get_attribute_fields" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Get the set of attribute fields</p>
<p>Return only the <em>first-level</em> attribute fields from the schema of the resource class,
resolving references along the way if needed.</p>

<details class="note" open>
  <summary>Note</summary>
  <p>It is not needed to take care of other special OpenAPI schema keys than <code>allOf</code>,
since only <code>allOf</code> will be found in this context.
Other special keys can be found in <a href="https://swagger.io/docs/specification/data-models/oneof-anyof-allof-not/">the Swagger documentation</a>.</p>
</details>


  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>set[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>Property names.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_attribute_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the set of attribute fields</span>

<span class="sd">    Return only the _first-level_ attribute fields from the schema of the resource class,</span>
<span class="sd">    resolving references along the way if needed.</span>

<span class="sd">    Note:</span>
<span class="sd">        It is not needed to take care of other special OpenAPI schema keys than `allOf`,</span>
<span class="sd">        since only `allOf` will be found in this context.</span>
<span class="sd">        Other special keys can be found in [the Swagger documentation](https://swagger.io/docs/specification/data-models/oneof-anyof-allof-not/).</span>

<span class="sd">    Returns:</span>
<span class="sd">        Property names.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">annotation</span> <span class="o">=</span> <span class="n">_get_origin_type</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resource_cls</span><span class="o">.</span><span class="n">model_fields</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">annotation</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">Attributes</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="s2">&quot;resource class &#39;attributes&#39; field must be a subclass of &#39;EntryResourceAttributes&#39;&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">model_fields</span><span class="p">)</span>  <span class="c1"># type: ignore[attr-defined]</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.get_next_query_params" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">get_next_query_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.get_next_query_params" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Provides url query pagination parameters that will be used in the next
link.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>results</code></td>
          <td>
                <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[dict[str, <span title="typing.Any">Any</span>], list[dict[str, <span title="typing.Any">Any</span>]]]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The results produced by find.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><a class="autorefs autorefs-internal" title="optimade.server.query_params.EntryListingQueryParams" href="../../query_params/#optimade.server.query_params.EntryListingQueryParams">EntryListingQueryParams</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The parsed request params produced by handle_query_params.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>dict[str, list[str]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary with the necessary query parameters.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_next_query_params</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">EntryListingQueryParams</span><span class="p">,</span>
    <span class="n">results</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides url query pagination parameters that will be used in the next</span>
<span class="sd">    link.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        results: The results produced by find.</span>
<span class="sd">        params: The parsed request params produced by handle_query_params.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary with the necessary query parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">results</span><span class="p">:</span>
        <span class="c1"># If a user passed a particular pagination mechanism, keep using it</span>
        <span class="c1"># Otherwise, use the default pagination mechanism of the collection</span>
        <span class="n">pagination_mechanism</span> <span class="o">=</span> <span class="n">PaginationMechanism</span><span class="o">.</span><span class="n">OFFSET</span>
        <span class="k">for</span> <span class="n">pagination_key</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;page_offset&quot;</span><span class="p">,</span>
            <span class="s2">&quot;page_number&quot;</span><span class="p">,</span>
            <span class="s2">&quot;page_above&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pagination_key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pagination_mechanism</span> <span class="o">=</span> <span class="n">PaginationMechanism</span><span class="p">(</span><span class="n">pagination_key</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">pagination_mechanism</span> <span class="o">==</span> <span class="n">PaginationMechanism</span><span class="o">.</span><span class="n">OFFSET</span><span class="p">:</span>
            <span class="n">query</span><span class="p">[</span><span class="s2">&quot;page_offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">page_offset</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>  <span class="c1"># type: ignore[list-item]</span>
            <span class="p">]</span>

    <span class="k">return</span> <span class="n">query</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.handle_query_params" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">handle_query_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.handle_query_params" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Parse and interpret the backend-agnostic query parameter models into a dictionary
that can be used by MongoDB.</p>
<p>This Mongo-specific method calls the base <code>EntryCollection.handle_query_params</code> method
and adds additional handling of the MongoDB ObjectID type.</p>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>params</code></td>
          <td>
                <code><span title="typing.Union">Union</span>[<a class="autorefs autorefs-internal" title="optimade.server.query_params.EntryListingQueryParams" href="../../query_params/#optimade.server.query_params.EntryListingQueryParams">EntryListingQueryParams</a>, <a class="autorefs autorefs-internal" title="optimade.server.query_params.SingleEntryQueryParams" href="../../query_params/#optimade.server.query_params.SingleEntryQueryParams">SingleEntryQueryParams</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The initialized query parameter model from the server.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>Forbidden</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If too large of a page limit is provided.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code>BadRequest</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If an invalid request is made, e.g., with incorrect fields
or response format.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>dict[str, <span title="typing.Any">Any</span>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A dictionary representation of the query parameters.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/mongo.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">handle_query_params</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">EntryListingQueryParams</span><span class="p">,</span> <span class="n">SingleEntryQueryParams</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse and interpret the backend-agnostic query parameter models into a dictionary</span>
<span class="sd">    that can be used by MongoDB.</span>

<span class="sd">    This Mongo-specific method calls the base `EntryCollection.handle_query_params` method</span>
<span class="sd">    and adds additional handling of the MongoDB ObjectID type.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        params: The initialized query parameter model from the server.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Forbidden: If too large of a page limit is provided.</span>
<span class="sd">        BadRequest: If an invalid request is made, e.g., with incorrect fields</span>
<span class="sd">            or response format.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary representation of the query parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">criteria</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">handle_query_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="c1"># Handle MongoDB ObjectIDs:</span>
    <span class="c1"># - If they were not requested, then explicitly remove them</span>
    <span class="c1"># - If they were requested, then cast them to strings in the response</span>
    <span class="k">if</span> <span class="s2">&quot;_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="p">{}):</span>
        <span class="n">criteria</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">][</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s2">&quot;page_above&quot;</span> <span class="ow">in</span> <span class="n">criteria</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s2">&quot;`page_above` is not implemented for this backend.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">criteria</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_id&quot;</span><span class="p">):</span>
        <span class="n">criteria</span><span class="p">[</span><span class="s2">&quot;projection&quot;</span><span class="p">][</span><span class="s2">&quot;_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$toString&quot;</span><span class="p">:</span> <span class="s2">&quot;$_id&quot;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">criteria</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.insert" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">insert</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.insert" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Add the given entries to the underlying database.</p>

<details class="warning" open>
  <summary>Warning</summary>
  <p>No validation is performed on the incoming data.</p>
</details>


  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>data</code></td>
          <td>
                <code>list[<a class="autorefs autorefs-internal" title="optimade.models.EntryResource" href="../../../../all_models/#optimade.models.EntryResource">EntryResource</a>]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The entry resource objects to add to the database.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/mongo.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">EntryResource</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add the given entries to the underlying database.</span>

<span class="sd">    Warning:</span>
<span class="sd">        No validation is performed on the incoming data.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        data: The entry resource objects to add to the database.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">collection</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoCollection.parse_sort_params" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">parse_sort_params</span><span class="p">(</span><span class="n">sort_params</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoCollection.parse_sort_params" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Handles any sort parameters passed to the collection,
resolving aliases and dealing with any invalid fields.</p>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><a class="autorefs autorefs-internal" title="optimade.exceptions.BadRequest" href="../../../exceptions/#optimade.exceptions.BadRequest">BadRequest</a></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>if an invalid sort is requested.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Returns:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code><span title="collections.abc.Iterable">Iterable</span>[tuple[str, int]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A list of tuples containing the aliased field name and</p>
            </div>
          </td>
        </tr>
        <tr>
          <td>
                <code><span title="collections.abc.Iterable">Iterable</span>[tuple[str, int]]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>sort direction encoded as 1 (ascending) or -1 (descending).</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/entry_collections/entry_collections.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">parse_sort_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort_params</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handles any sort parameters passed to the collection,</span>
<span class="sd">    resolving aliases and dealing with any invalid fields.</span>

<span class="sd">    Raises:</span>
<span class="sd">        BadRequest: if an invalid sort is requested.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of tuples containing the aliased field name and</span>
<span class="sd">        sort direction encoded as 1 (ascending) or -1 (descending).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sort_spec</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">sort_params</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
        <span class="n">sort_dir</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">sort_dir</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">aliased_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">get_backend_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
        <span class="n">sort_spec</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">aliased_field</span><span class="p">,</span> <span class="n">sort_dir</span><span class="p">))</span>

    <span class="n">unknown_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">field</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">sort_spec</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_mapper</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_fields</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="n">unknown_fields</span><span class="p">:</span>
        <span class="n">error_detail</span> <span class="o">=</span> <span class="s2">&quot;Unable to sort on unknown field</span><span class="si">{}</span><span class="s2"> &#39;</span><span class="si">{}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="s2">&quot;s&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&#39;, &#39;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unknown_fields</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># If all unknown fields are &quot;other&quot; provider-specific, then only provide a warning</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">(</span>
                <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;_[a-z_0-9]+_[a-z_0-9]*&quot;</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">provider_prefix</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">unknown_fields</span>
        <span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">error_detail</span><span class="p">,</span> <span class="n">FieldValueNotRecognized</span><span class="p">)</span>

        <span class="c1"># Otherwise, if all fields are unknown, or some fields are unknown and do not</span>
        <span class="c1"># have other provider prefixes, then return 400: Bad Request</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="n">error_detail</span><span class="p">)</span>

    <span class="c1"># If at least one valid field has been provided for sorting, then use that</span>
    <span class="n">sort_spec</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">sort_dir</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">sort_dir</span> <span class="ow">in</span> <span class="n">sort_spec</span>
        <span class="k">if</span> <span class="n">field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unknown_fields</span>
    <span class="p">]</span>

    <span class="k">return</span> <span class="n">sort_spec</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="optimade.server.entry_collections.mongo.MongoTransformer" class="doc doc-heading">
          <code>MongoTransformer</code>


<a href="#optimade.server.entry_collections.mongo.MongoTransformer" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><a class="autorefs autorefs-internal" title="optimade.filtertransformers.base_transformer.BaseTransformer" href="../../../filtertransformers/base_transformer/#optimade.filtertransformers.base_transformer.BaseTransformer">BaseTransformer</a></code></p>

  
      <p>A filter transformer for the MongoDB backend.</p>
<p>Parses a lark tree into a dictionary representation to be
used by pymongo or mongomock. Uses post-processing functions
to handle some specific edge-cases for MongoDB.</p>



  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>operator_map</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A map from comparison operators
to the mongoDB specific versions.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>inverse_operator_map</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A map from operators to their
logical inverse.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>mapper</code></td>
          <td>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A resource mapper object that defines the
expected fields and acts as a container for
various field-related configuration.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

            <details class="quote">
              <summary>Source code in <code>optimade/filtertransformers/mongo.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MongoTransformer</span><span class="p">(</span><span class="n">BaseTransformer</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A filter transformer for the MongoDB backend.</span>

<span class="sd">    Parses a lark tree into a dictionary representation to be</span>
<span class="sd">    used by pymongo or mongomock. Uses post-processing functions</span>
<span class="sd">    to handle some specific edge-cases for MongoDB.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        operator_map: A map from comparison operators</span>
<span class="sd">            to the mongoDB specific versions.</span>
<span class="sd">        inverse_operator_map: A map from operators to their</span>
<span class="sd">            logical inverse.</span>
<span class="sd">        mapper: A resource mapper object that defines the</span>
<span class="sd">            expected fields and acts as a container for</span>
<span class="sd">            various field-related configuration.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">operator_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;&lt;&quot;</span><span class="p">:</span> <span class="s2">&quot;$lt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt;=&quot;</span><span class="p">:</span> <span class="s2">&quot;$lte&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&gt;&quot;</span><span class="p">:</span> <span class="s2">&quot;$gt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&gt;=&quot;</span><span class="p">:</span> <span class="s2">&quot;$gte&quot;</span><span class="p">,</span>
        <span class="s2">&quot;!=&quot;</span><span class="p">:</span> <span class="s2">&quot;$ne&quot;</span><span class="p">,</span>
        <span class="s2">&quot;=&quot;</span><span class="p">:</span> <span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">inverse_operator_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;$lt&quot;</span><span class="p">:</span> <span class="s2">&quot;$gte&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$lte&quot;</span><span class="p">:</span> <span class="s2">&quot;$gt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$gt&quot;</span><span class="p">:</span> <span class="s2">&quot;$lte&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$gte&quot;</span><span class="p">:</span> <span class="s2">&quot;$lt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$eq&quot;</span><span class="p">:</span> <span class="s2">&quot;$ne&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="s2">&quot;$nin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;$nin&quot;</span><span class="p">:</span> <span class="s2">&quot;$in&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Used to post-process the nested dictionary of the parsed query.&quot;&quot;&quot;</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_relationship_filtering</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_length_operators</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_unknown_or_null_filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_has_only_filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_mongo_id_filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_mongo_date_filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">query</span>

    <span class="k">def</span> <span class="nf">value_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># value_list: [ OPERATOR ] value ( &quot;,&quot; [ OPERATOR ] value )*</span>
        <span class="c1"># NOTE: no support for optional OPERATOR, yet, so this takes the</span>
        <span class="c1"># parsed values and returns an error if that is being attempted</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator_map</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;OPERATOR </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> inside value_list </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2"> not implemented.&quot;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">arg</span>

    <span class="k">def</span> <span class="nf">value_zip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># value_zip: [ OPERATOR ] value &quot;:&quot; [ OPERATOR ] value (&quot;:&quot; [ OPERATOR ] value)*</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Correlated list queries are not supported.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">value_zip_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># value_zip_list: value_zip ( &quot;,&quot; value_zip )*</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Correlated list queries are not supported.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># expression: expression_clause ( OR expression_clause )</span>
        <span class="c1"># expression with and without &#39;OR&#39;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$or&quot;</span><span class="p">:</span> <span class="n">arg</span><span class="p">}</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">expression_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># expression_clause: expression_phrase ( AND expression_phrase )*</span>
        <span class="c1"># expression_clause with and without &#39;AND&#39;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$and&quot;</span><span class="p">:</span> <span class="n">arg</span><span class="p">}</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">expression_phrase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># expression_phrase: [ NOT ] ( comparison | &quot;(&quot; expression &quot;)&quot; )</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recursive_expression_phrase</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

    <span class="nd">@v_args</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">property_first_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quantity</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
        <span class="c1"># property_first_comparison: property ( value_op_rhs | known_op_rhs | fuzzy_string_op_rhs | set_op_rhs |</span>
        <span class="c1"># set_zip_op_rhs | length_op_rhs )</span>

        <span class="c1"># Awkwardly, MongoDB will match null fields in $ne filters,</span>
        <span class="c1"># so we need to add a check for null equality in evey $ne query.</span>
        <span class="k">if</span> <span class="s2">&quot;$ne&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$and&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="n">quantity</span><span class="p">:</span> <span class="n">query</span><span class="p">},</span> <span class="p">{</span><span class="n">quantity</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}]}</span>

        <span class="c1"># Check if a $size query is being made (indicating a length_op_rhs filter); if so, check for</span>
        <span class="c1"># a defined length alias to replace the $size call with the corresponding filter on the</span>
        <span class="c1"># length quantity then carefully merge the two queries.</span>
        <span class="c1">#</span>
        <span class="c1"># e.g. `(&quot;elements&quot;, {&quot;$size&quot;: 2, &quot;$all&quot;: [&quot;Ag&quot;, &quot;Au&quot;]})` should become</span>
        <span class="c1"># `{&quot;elements&quot;: {&quot;$all&quot;: [&quot;Ag&quot;, &quot;Au&quot;]}, &quot;nelements&quot;: 2}` if the `elements` -&gt; `nelements`</span>
        <span class="c1"># length alias is defined.</span>
        <span class="k">if</span> <span class="s2">&quot;$size&quot;</span> <span class="ow">in</span> <span class="n">query</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">quantity</span><span class="p">),</span> <span class="s2">&quot;length_quantity&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="p">):</span>
                <span class="n">size_query</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">backend_mapping</span><span class="p">[</span>  <span class="c1"># type: ignore[union-attr]</span>
                        <span class="n">quantity</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">length_quantity</span><span class="o">.</span><span class="n">backend_field</span><span class="p">:</span> <span class="n">query</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;$size&quot;</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="n">final_query</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">query</span><span class="p">:</span>
                    <span class="n">final_query</span> <span class="o">=</span> <span class="p">{</span><span class="n">quantity</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
                <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">size_query</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">final_query</span><span class="p">:</span>
                        <span class="n">final_query</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">size_query</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">final_query</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">size_query</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">final_query</span>

        <span class="k">return</span> <span class="p">{</span><span class="n">quantity</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">constant_first_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># constant_first_comparison: constant OPERATOR ( non_string_value | not_implemented_string )</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">property_first_comparison</span><span class="p">(</span>
            <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">operator_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_reversed_operator_map</span><span class="p">[</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]:</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
        <span class="p">)</span>

    <span class="nd">@v_args</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">value_op_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># value_op_rhs: OPERATOR value</span>
        <span class="k">return</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">operator_map</span><span class="p">[</span><span class="n">operator</span><span class="p">]:</span> <span class="n">value</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">known_op_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># known_op_rhs: IS ( KNOWN | UNKNOWN )</span>
        <span class="c1"># The OPTIMADE spec also required a type comparison with null, this must be post-processed</span>
        <span class="c1"># so here we use a special key &quot;#known&quot; which will get replaced in post-processing with the</span>
        <span class="c1"># expanded dict</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;#known&quot;</span><span class="p">:</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;KNOWN&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">fuzzy_string_op_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># fuzzy_string_op_rhs: CONTAINS value | STARTS [ WITH ] value | ENDS [ WITH ] value</span>

        <span class="c1"># The WITH keyword may be omitted.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Token</span><span class="p">)</span> <span class="ow">and</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;WITH&quot;</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pattern</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># CONTAINS</span>
        <span class="k">if</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CONTAINS&quot;</span><span class="p">:</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;STARTS&quot;</span><span class="p">:</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;^</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ENDS&quot;</span><span class="p">:</span>
            <span class="n">regex</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pattern</span><span class="si">}</span><span class="s2">$&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$regex&quot;</span><span class="p">:</span> <span class="n">regex</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">set_op_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># set_op_rhs: HAS ( [ OPERATOR ] value | ALL value_list | ANY value_list | ONLY value_list )</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># only value without OPERATOR</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]}</span>

        <span class="k">if</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ALL&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$all&quot;</span><span class="p">:</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>

        <span class="k">if</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ANY&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>

        <span class="k">if</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;ONLY&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;#only&quot;</span><span class="p">:</span> <span class="n">arg</span><span class="p">[</span><span class="mi">2</span><span class="p">]}</span>

        <span class="c1"># value with OPERATOR</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;set_op_rhs not implemented for use with OPERATOR. Given: </span><span class="si">{</span><span class="n">arg</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># property: IDENTIFIER ( &quot;.&quot; IDENTIFIER )*</span>
        <span class="n">quantity</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">property</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">quantity</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">):</span>
            <span class="n">quantity</span> <span class="o">=</span> <span class="n">quantity</span><span class="o">.</span><span class="n">backend_field</span>

        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">quantity</span><span class="p">]</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="k">def</span> <span class="nf">length_op_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># length_op_rhs: LENGTH [ OPERATOR ] value</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;=&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$size&quot;</span><span class="p">:</span> <span class="n">arg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]}</span>

        <span class="k">if</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator_map</span> <span class="ow">and</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;!=&quot;</span><span class="p">:</span>
            <span class="c1"># create an invalid query that needs to be post-processed</span>
            <span class="c1"># e.g. {&#39;$size&#39;: {&#39;$gt&#39;: 2}}, which is not allowed by Mongo.</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$size&quot;</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">operator_map</span><span class="p">[</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]]:</span> <span class="n">arg</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]}}</span>

        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Operator </span><span class="si">{</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> not implemented for LENGTH filter.&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_zip_op_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># set_zip_op_rhs: property_zip_addon HAS ( value_zip | ONLY value_zip_list | ALL value_zip_list |</span>
        <span class="c1"># ANY value_zip_list )</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Correlated list queries are not supported.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">property_zip_addon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="c1"># property_zip_addon: &quot;:&quot; property (&quot;:&quot; property)*</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Correlated list queries are not supported.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_recursive_expression_phrase</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">:</span> <span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Helper function for parsing `expression_phrase`. Recursively sorts out</span>
<span class="sd">        the correct precedence for `$not`, `$and` and `$or`.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            arg: A list containing the expression to be evaluated and whether it</span>
<span class="sd">                is negated, e.g., `[&quot;NOT&quot;, expr]` or just `[expr]`.</span>

<span class="sd">        Returns:</span>
<span class="sd">             The evaluated filter as a nested dictionary.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">handle_not_and</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle the case of `~(A &amp; B) -&gt; (~A | ~B)`.</span>

<span class="sd">            We have to check for the special case in which the &quot;and&quot; was created</span>
<span class="sd">            by a previous NOT, e.g.,</span>
<span class="sd">            `NOT (NOT ({&quot;a&quot;: {&quot;$eq&quot;: 6}})) -&gt; NOT({&quot;$and&quot;: [{&quot;a&quot;: {&quot;$ne&quot;: 6}},{&quot;a&quot;: {&quot;$ne&quot;: None}}]})`</span>

<span class="sd">            Parameters:</span>
<span class="sd">                arg: A dictionary with key `&quot;$and&quot;` containing a list of expressions.</span>

<span class="sd">            Returns:</span>
<span class="sd">                A dictionary with key `&quot;$or&quot;` containing a list of the appropriate negated expressions.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="n">expr1</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">expr2</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">expr1</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="n">expr2</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">expr1</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">((</span><span class="n">expr1</span><span class="p">,</span> <span class="n">expr2</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}:</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recursive_expression_phrase</span><span class="p">([</span><span class="s2">&quot;NOT&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">])</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;$or&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_recursive_expression_phrase</span><span class="p">([</span><span class="s2">&quot;NOT&quot;</span><span class="p">,</span> <span class="n">subdict</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">subdict</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">}</span>

        <span class="k">def</span> <span class="nf">handle_not_or</span><span class="p">(</span><span class="n">arg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Handle the case of ~(A | B) -&gt; (~A &amp; ~B).</span>

<span class="sd">            !!! note</span>
<span class="sd">            Although the MongoDB `$nor` could be used here, it is not convenient as it</span>
<span class="sd">            will also return documents where the filtered field is missing when testing</span>
<span class="sd">            for inequality.</span>

<span class="sd">            Parameters:</span>
<span class="sd">                arg: A dictionary with key `&quot;$or&quot;` containing a list of expressions.</span>

<span class="sd">            Returns:</span>
<span class="sd">                A dictionary with key `&quot;$and&quot;` that lists the appropriate negated expressions.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;$and&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_recursive_expression_phrase</span><span class="p">([</span><span class="s2">&quot;NOT&quot;</span><span class="p">,</span> <span class="n">subdict</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">subdict</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">[</span><span class="s2">&quot;$or&quot;</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">}</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># without NOT</span>
            <span class="k">return</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;$or&quot;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">handle_not_or</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="s2">&quot;$and&quot;</span> <span class="ow">in</span> <span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">handle_not_and</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">prop</span><span class="p">,</span> <span class="n">expr</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">arg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="n">operator</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">operator</span> <span class="o">==</span> <span class="s2">&quot;$not&quot;</span><span class="p">:</span>  <span class="c1"># Case of double negation e.g. NOT(&quot;$not&quot;:{ ...})</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>

        <span class="c1"># If the NOT operator occurs at the lowest nesting level,</span>
        <span class="c1"># the expression can be simplified by using the opposite operator and removing the not.</span>
        <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">inverse_operator_map</span><span class="p">:</span>
            <span class="n">filter_</span> <span class="o">=</span> <span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inverse_operator_map</span><span class="p">[</span><span class="n">operator</span><span class="p">]:</span> <span class="n">value</span><span class="p">}}</span>
            <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;$in&quot;</span><span class="p">,</span> <span class="s2">&quot;$eq&quot;</span><span class="p">):</span>
                <span class="n">filter_</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$and&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">filter_</span><span class="p">,</span> <span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}]}</span>  <span class="c1"># type: ignore[dict-item]</span>
            <span class="k">return</span> <span class="n">filter_</span>

        <span class="n">filter_</span> <span class="o">=</span> <span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$not&quot;</span><span class="p">:</span> <span class="n">expr</span><span class="p">}}</span>
        <span class="k">if</span> <span class="s2">&quot;#known&quot;</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">filter_</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;$and&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">filter_</span><span class="p">,</span> <span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$ne&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}}]}</span>

    <span class="k">def</span> <span class="nf">_apply_length_operators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check for any invalid pymongo queries that involve applying a</span>
<span class="sd">        comparison operator to the length of a field, and transform</span>
<span class="sd">        them into a test for existence of the relevant entry, e.g.</span>
<span class="sd">        &quot;list LENGTH &gt; 3&quot; becomes &quot;does the 4th list entry exist?&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">check_for_length_op_filter</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
                <span class="ow">and</span> <span class="s2">&quot;$size&quot;</span> <span class="ow">in</span> <span class="n">expr</span>
                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="s2">&quot;$size&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">apply_length_op</span><span class="p">(</span><span class="n">subdict</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
            <span class="c1"># assumes that the dictionary only has one element by design</span>
            <span class="c1"># (we just made it above in the transformer)</span>
            <span class="n">operator</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">expr</span><span class="p">[</span><span class="s2">&quot;$size&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">operator</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operator_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">and</span> <span class="n">operator</span> <span class="o">!=</span> <span class="s2">&quot;$ne&quot;</span><span class="p">:</span>
                <span class="c1"># worth being explicit here, I think</span>
                <span class="n">_prop</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">existence</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">operator</span> <span class="o">==</span> <span class="s2">&quot;$gt&quot;</span><span class="p">:</span>
                    <span class="n">_prop</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">existence</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s2">&quot;$gte&quot;</span><span class="p">:</span>
                    <span class="n">_prop</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">existence</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s2">&quot;$lt&quot;</span><span class="p">:</span>
                    <span class="n">_prop</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">existence</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s2">&quot;$lte&quot;</span><span class="p">:</span>
                    <span class="n">_prop</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">existence</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">_prop</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">subdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
                    <span class="n">subdict</span><span class="p">[</span><span class="n">_prop</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="n">existence</span><span class="p">}</span>

            <span class="k">return</span> <span class="n">subdict</span>

        <span class="k">return</span> <span class="n">recursive_postprocessing</span><span class="p">(</span>
            <span class="n">filter_</span><span class="p">,</span>
            <span class="n">check_for_length_op_filter</span><span class="p">,</span>
            <span class="n">apply_length_op</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_relationship_filtering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check query for property names that match the entry</span>
<span class="sd">        types, and transform them as relationship filters rather than</span>
<span class="sd">        property filters.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">check_for_entry_type</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;structures&quot;</span><span class="p">,</span>
                <span class="s2">&quot;references&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">replace_with_relationship</span><span class="p">(</span><span class="n">subdict</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
            <span class="n">_prop</span><span class="p">,</span> <span class="n">_field</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_field</span> <span class="o">!=</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;Cannot filter relationships by field &quot;</span><span class="si">{</span><span class="n">_field</span><span class="si">}</span><span class="s1">&quot;, only &quot;id&quot; is supported.&#39;</span>
                <span class="p">)</span>

            <span class="n">subdict</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;relationships.</span><span class="si">{</span><span class="n">_prop</span><span class="si">}</span><span class="s2">.data.</span><span class="si">{</span><span class="n">_field</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expr</span>
            <span class="n">subdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">subdict</span>

        <span class="k">return</span> <span class="n">recursive_postprocessing</span><span class="p">(</span>
            <span class="n">filter_</span><span class="p">,</span> <span class="n">check_for_entry_type</span><span class="p">,</span> <span class="n">replace_with_relationship</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_has_only_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method loops through the query and replaces the magic key `&quot;#only&quot;`</span>
<span class="sd">        with the proper &#39;HAS ONLY&#39; query.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">check_for_only_filter</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Find cases where the magic key `&quot;#only&quot;` is in the query.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;#only&quot;</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">replace_only_filter</span><span class="p">(</span><span class="n">subdict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">prop</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Replace the magic key `&quot;#only&quot;` (added by this transformer) with an `$elemMatch`-based query.</span>

<span class="sd">            The first part of the query selects all the documents that contain any value that does not</span>
<span class="sd">            match any target values for the property `prop`.</span>
<span class="sd">            Subsequently, this selection is inverted, to get the documents that only have</span>
<span class="sd">            the allowed values.</span>
<span class="sd">            This inversion also selects documents with edge-case values such as null or empty lists;</span>
<span class="sd">            these are removed in the second part of the query that makes sure that only documents</span>
<span class="sd">            with lists that have at least one value are selected.</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="s2">&quot;$and&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subdict</span><span class="p">:</span>
                <span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;relationships.&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;relationships.references.data.id&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;relationships.structures.data.id&quot;</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unable to query on unrecognised field </span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">first_part_prop</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="n">first_part_prop</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">&quot;$not&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$elemMatch&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$nin&quot;</span><span class="p">:</span> <span class="n">expr</span><span class="p">[</span><span class="s2">&quot;#only&quot;</span><span class="p">]}}}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">)</span>
                <span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">first_part_prop</span> <span class="o">+</span> <span class="s2">&quot;.0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span><span class="n">prop</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$not&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$elemMatch&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$nin&quot;</span><span class="p">:</span> <span class="n">expr</span><span class="p">[</span><span class="s2">&quot;#only&quot;</span><span class="p">]}}}}</span>
                <span class="p">)</span>
                <span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;$and&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">prop</span> <span class="o">+</span> <span class="s2">&quot;.0&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>

            <span class="n">subdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">subdict</span>

        <span class="k">return</span> <span class="n">recursive_postprocessing</span><span class="p">(</span>
            <span class="n">filter_</span><span class="p">,</span> <span class="n">check_for_only_filter</span><span class="p">,</span> <span class="n">replace_only_filter</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_unknown_or_null_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method loops through the query and replaces the check for</span>
<span class="sd">        KNOWN with a check for existence and a check for not null, and the</span>
<span class="sd">        inverse for UNKNOWN.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">check_for_known_filter</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Find cases where the query dict looks like</span>
<span class="sd">            `{&quot;field&quot;: {&quot;#known&quot;: T/F}}` or</span>
<span class="sd">            `{&quot;field&quot;: &quot;$not&quot;: {&quot;#known&quot;: T/F}}`, which is a magic word</span>
<span class="sd">            for KNOWN/UNKNOWN filters in this transformer.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="s2">&quot;#known&quot;</span> <span class="ow">in</span> <span class="n">expr</span> <span class="ow">or</span> <span class="s2">&quot;#known&quot;</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;$not&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="p">)</span>

        <span class="k">def</span> <span class="nf">replace_known_filter_with_or</span><span class="p">(</span><span class="n">subdict</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Replace magic key `&quot;#known&quot;` (added by this transformer) with the appropriate</span>
<span class="sd">            combination of `$exists` and/or test for nullity.</span>
<span class="sd">            combination of $exists and/or $eq/$ne null.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">not_</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="p">{</span><span class="s2">&quot;$not&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">not_</span><span class="p">:</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="s2">&quot;$not&quot;</span><span class="p">]</span>

            <span class="n">exists</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="s2">&quot;#known&quot;</span><span class="p">]</span> <span class="o">^</span> <span class="n">not_</span>

            <span class="n">top_level_key</span> <span class="o">=</span> <span class="s2">&quot;$or&quot;</span>
            <span class="n">comparison_operator</span> <span class="o">=</span> <span class="s2">&quot;$eq&quot;</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">:</span>
                <span class="n">top_level_key</span> <span class="o">=</span> <span class="s2">&quot;$and&quot;</span>
                <span class="n">comparison_operator</span> <span class="o">=</span> <span class="s2">&quot;$ne&quot;</span>

            <span class="k">if</span> <span class="n">top_level_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subdict</span><span class="p">:</span>
                <span class="n">subdict</span><span class="p">[</span><span class="n">top_level_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">subdict</span><span class="p">[</span><span class="n">top_level_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">prop</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$exists&quot;</span><span class="p">:</span> <span class="n">exists</span><span class="p">}})</span>
            <span class="n">subdict</span><span class="p">[</span><span class="n">top_level_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">prop</span><span class="p">:</span> <span class="p">{</span><span class="n">comparison_operator</span><span class="p">:</span> <span class="kc">None</span><span class="p">}})</span>

            <span class="n">subdict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">subdict</span>

        <span class="k">return</span> <span class="n">recursive_postprocessing</span><span class="p">(</span>
            <span class="n">filter_</span><span class="p">,</span> <span class="n">check_for_known_filter</span><span class="p">,</span> <span class="n">replace_known_filter_with_or</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_mongo_id_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method loops through the query and replaces any operations</span>
<span class="sd">        on the special Mongodb `_id` key with the corresponding operation</span>
<span class="sd">        on a BSON `ObjectId` type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">check_for_id_key</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Find cases where the query dict is operating on the `_id` field.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">prop</span> <span class="o">==</span> <span class="s2">&quot;_id&quot;</span>

        <span class="k">def</span> <span class="nf">replace_str_id_with_objectid</span><span class="p">(</span><span class="n">subdict</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
            <span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">ObjectId</span>

            <span class="k">for</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">subdict</span><span class="p">[</span><span class="n">prop</span><span class="p">]:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">subdict</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">operator</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">operator</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;$eq&quot;</span><span class="p">,</span> <span class="s2">&quot;$ne&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Operator </span><span class="si">{</span><span class="n">operator</span><span class="si">}</span><span class="s2"> not supported for query on field </span><span class="si">{</span><span class="n">prop</span><span class="si">!r}</span><span class="s2">, can only test for equality&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">subdict</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">operator</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObjectId</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">subdict</span>

        <span class="k">return</span> <span class="n">recursive_postprocessing</span><span class="p">(</span>
            <span class="n">filter_</span><span class="p">,</span> <span class="n">check_for_id_key</span><span class="p">,</span> <span class="n">replace_str_id_with_objectid</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_apply_mongo_date_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;This method loops through the query and replaces any operations</span>
<span class="sd">        on suspected timestamp properties with the corresponding operation</span>
<span class="sd">        on a BSON `DateTime` type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">check_for_timestamp_field</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">_</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Find cases where the query dict is operating on a timestamp field.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">get_optimade_field</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">prop</span> <span class="o">==</span> <span class="s2">&quot;last_modified&quot;</span>

        <span class="k">def</span> <span class="nf">replace_str_date_with_datetime</span><span class="p">(</span><span class="n">subdict</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">expr</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Encode suspected dates in with BSON.&quot;&quot;&quot;</span>
            <span class="kn">import</span> <span class="nn">bson.json_util</span>

            <span class="k">for</span> <span class="n">operator</span> <span class="ow">in</span> <span class="n">subdict</span><span class="p">[</span><span class="n">prop</span><span class="p">]:</span>
                <span class="n">query_datetime</span> <span class="o">=</span> <span class="n">bson</span><span class="o">.</span><span class="n">json_util</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                    <span class="n">bson</span><span class="o">.</span><span class="n">json_util</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;$date&quot;</span><span class="p">:</span> <span class="n">subdict</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">operator</span><span class="p">]}),</span>
                    <span class="n">json_options</span><span class="o">=</span><span class="n">bson</span><span class="o">.</span><span class="n">json_util</span><span class="o">.</span><span class="n">DEFAULT_JSON_OPTIONS</span><span class="o">.</span><span class="n">with_options</span><span class="p">(</span>
                        <span class="n">tz_aware</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">bson</span><span class="o">.</span><span class="n">tz_util</span><span class="o">.</span><span class="n">utc</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">query_datetime</span><span class="o">.</span><span class="n">microsecond</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Query for timestamp </span><span class="si">{</span><span class="n">subdict</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">operator</span><span class="p">]</span><span class="si">!r}</span><span class="s2"> for field </span><span class="si">{</span><span class="n">prop</span><span class="si">!r}</span><span class="s2"> contained microseconds, which is not RFC3339 compliant. &quot;</span>
                        <span class="s2">&quot;This may cause undefined behaviour for the underlying database.&quot;</span><span class="p">,</span>
                        <span class="n">TimestampNotRFCCompliant</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">subdict</span><span class="p">[</span><span class="n">prop</span><span class="p">][</span><span class="n">operator</span><span class="p">]</span> <span class="o">=</span> <span class="n">query_datetime</span>

            <span class="k">return</span> <span class="n">subdict</span>

        <span class="k">return</span> <span class="n">recursive_postprocessing</span><span class="p">(</span>
            <span class="n">filter_</span><span class="p">,</span> <span class="n">check_for_timestamp_field</span><span class="p">,</span> <span class="n">replace_str_date_with_datetime</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.backend_mapping" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">backend_mapping</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.backend_mapping" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>A mapping between backend field names (aliases) and the corresponding
<a class="autorefs autorefs-internal" href="../../../filtertransformers/base_transformer/#optimade.filtertransformers.base_transformer.Quantity"><code>Quantity</code></a> object.</p>
  </div>

</div>

<div class="doc doc-object doc-attribute">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.quantities" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">quantities</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Quantity</span><span class="p">]</span></code>
  
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
      <small class="doc doc-label doc-label-writable"><code>writable</code></small>
  </span>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.quantities" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>A mapping from the OPTIMADE field name to the corresponding
<a class="autorefs autorefs-internal" href="../../../filtertransformers/base_transformer/#optimade.filtertransformers.base_transformer.Quantity"><code>Quantity</code></a> objects.</p>
  </div>

</div>




<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.__default__" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">__default__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">meta</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.__default__" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>The default rule to call when no definition is found for a particular construct.</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">__default__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">children</span><span class="p">,</span> <span class="n">meta</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The default rule to call when no definition is found for a particular construct.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Calling __default__, i.e., unknown grammar concept. data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">, children: </span><span class="si">{</span><span class="n">children</span><span class="si">}</span><span class="s2">, meta: </span><span class="si">{</span><span class="n">meta</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.__init__" class="doc doc-heading">
          <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">mapper</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Initialise the transformer object, optionally loading in a
resource mapper for use when post-processing.</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">BaseResourceMapper</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>  <span class="c1"># pylint: disable=super-init-not-called</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialise the transformer object, optionally loading in a</span>
<span class="sd">    resource mapper for use when post-processing.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">mapper</span> <span class="o">=</span> <span class="n">mapper</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.comparison" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">comparison</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.comparison" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>comparison: constant_first_comparison | property_first_comparison</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@v_args</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;comparison: constant_first_comparison | property_first_comparison&quot;&quot;&quot;</span>
    <span class="c1"># Note: Return as is.</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.constant" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">constant</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.constant" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>constant: string | number</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@v_args</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">constant</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;constant: string | number&quot;&quot;&quot;</span>
    <span class="c1"># Note: Return as is.</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.filter" class="doc doc-heading">
          <code class="highlight language-python"><span class="nb">filter</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.filter" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>filter: expression*</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;filter: expression*&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">arg</span> <span class="k">else</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.non_string_value" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">non_string_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.non_string_value" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>non_string_value: number | property</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@v_args</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">non_string_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;non_string_value: number | property&quot;&quot;&quot;</span>
    <span class="c1"># Note: Return as is.</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.not_implemented_string" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">not_implemented_string</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.not_implemented_string" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>not_implemented_string: value</p>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>NotImplementedError</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>For further information, see Materials-Consortia/OPTIMADE issue 157:
https://github.com/Materials-Consortia/OPTIMADE/issues/157</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@v_args</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">not_implemented_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;not_implemented_string: value</span>

<span class="sd">    Raises:</span>
<span class="sd">        NotImplementedError: For further information, see Materials-Consortia/OPTIMADE issue 157:</span>
<span class="sd">            https://github.com/Materials-Consortia/OPTIMADE/issues/157</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Comparing strings is not yet implemented.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.number" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">number</span><span class="p">(</span><span class="n">number</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.number" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>number: SIGNED_INT | SIGNED_FLOAT</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@v_args</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;number: SIGNED_INT | SIGNED_FLOAT&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">type_</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">type</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">number</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;SIGNED_INT&quot;</span><span class="p">:</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="nb">int</span>
    <span class="k">elif</span> <span class="n">number</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;SIGNED_FLOAT&quot;</span><span class="p">:</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="nb">float</span>
    <span class="k">return</span> <span class="n">type_</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.postprocess" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">postprocess</span><span class="p">(</span><span class="n">query</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.postprocess" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Used to post-process the nested dictionary of the parsed query.</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/mongo.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Used to post-process the nested dictionary of the parsed query.&quot;&quot;&quot;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_relationship_filtering</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_length_operators</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_unknown_or_null_filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_has_only_filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_mongo_id_filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_mongo_date_filter</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">query</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.signed_int" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">signed_int</span><span class="p">(</span><span class="n">number</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.signed_int" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>signed_int : SIGNED_INT</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@v_args</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">signed_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;signed_int : SIGNED_INT&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.string" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">string</span><span class="p">(</span><span class="n">string</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.string" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>string: ESCAPED_STRING</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@v_args</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;string: ESCAPED_STRING&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">string</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.transform" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">transform</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.transform" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>Transform the query using the Lark <code>Transformer</code> then run the
backend-specific post-processing methods.</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="n">Tree</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transform the query using the Lark `Transformer` then run the</span>
<span class="sd">    backend-specific post-processing methods.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">postprocess</span><span class="p">(</span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>


<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.MongoTransformer.value" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.MongoTransformer.value" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>value: string | number | property</p>

          <details class="quote">
            <summary>Source code in <code>optimade/filtertransformers/base_transformer.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@v_args</span><span class="p">(</span><span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;value: string | number | property&quot;&quot;&quot;</span>
    <span class="c1"># Note: Return as is.</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="optimade.server.entry_collections.mongo.SingleEntryQueryParams" class="doc doc-heading">
          <code>SingleEntryQueryParams</code>


<a href="#optimade.server.entry_collections.mongo.SingleEntryQueryParams" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><a class="autorefs autorefs-internal" title="optimade.server.query_params.BaseQueryParams" href="../../query_params/#optimade.server.query_params.BaseQueryParams">BaseQueryParams</a></code></p>

  
      <p>Common query params for single entry endpoints.</p>



  <p><strong>Attributes:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>response_format</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>The output format requested (see section Response Format).
Defaults to the format string 'json', which specifies the standard output format described in this specification.</p>
<p><strong>Example</strong>: <code>http://example.com/v1/structures?response_format=xml</code></p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>email_address</code></td>
          <td>
                <code><span title="pydantic.EmailStr">EmailStr</span></code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An email address of the user making the request.
The email SHOULD be that of a person and not an automatic system.</p>
<p><strong>Example</strong>: <code>http://example.com/v1/structures?email_address=user@example.com</code></p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>response_fields</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A comma-delimited set of fields to be provided in the output.
If provided, these fields MUST be returned along with the REQUIRED fields.
Other OPTIONAL fields MUST NOT be returned when this parameter is present.</p>
<p><strong>Example</strong>: <code>http://example.com/v1/structures?response_fields=last_modified,nsites</code></p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>include</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>A server MAY implement the JSON API concept of returning <a href="https://jsonapi.org/format/1.0/#document-compound-documents">compound documents</a>
by utilizing the <code>include</code> query parameter as specified by <a href="https://jsonapi.org/format/1.0/#fetching-includes">JSON API 1.0</a>.</p>
<p>All related resource objects MUST be returned as part of an array value for the top-level <code>included</code> field,
see the section JSON Response Schema: Common Fields.</p>
<p>The value of <code>include</code> MUST be a comma-separated list of "relationship paths", as defined in the <a href="https://jsonapi.org/format/1.0/#fetching-includes">JSON API</a>.
If relationship paths are not supported, or a server is unable to identify a relationship path a <code>400 Bad Request</code> response MUST be made.</p>
<p>The <strong>default value</strong> for <code>include</code> is <code>references</code>. This means <code>references</code> entries MUST always be included under the top-level field
<code>included</code> as default, since a server assumes if <code>include</code> is not specified by a client in the request, it is still specified as <code>include=references</code>.
Note, if a client explicitly specifies <code>include</code> and leaves out <code>references</code>, <code>references</code> resource objects MUST NOT be included under the top-level
field <code>included</code>, as per the definition of <code>included</code>, see section JSON Response Schema: Common Fields.</p>
<p><strong>Note</strong>: A query with the parameter <code>include</code> set to the empty string means no related resource objects are to be returned under the top-level field <code>included</code>.</p>
            </div>
          </td>
        </tr>
        <tr>
          <td><code>api_hint</code></td>
          <td>
                <code>str</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>If the client provides the parameter, the value SHOULD have the format <code>vMAJOR</code> or <code>vMAJOR.MINOR</code>,
where MAJOR is a major version and MINOR is a minor version of the API.
For example, if a client appends <code>api_hint=v1.0</code> to the query string, the hint provided is for major version 1 and minor version 0.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

            <details class="quote">
              <summary>Source code in <code>optimade/server/query_params.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SingleEntryQueryParams</span><span class="p">(</span><span class="n">BaseQueryParams</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Common query params for single entry endpoints.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        response_format (str): The output format requested (see section Response Format).</span>
<span class="sd">            Defaults to the format string &#39;json&#39;, which specifies the standard output format described in this specification.</span>

<span class="sd">            **Example**: `http://example.com/v1/structures?response_format=xml`</span>

<span class="sd">        email_address (EmailStr): An email address of the user making the request.</span>
<span class="sd">            The email SHOULD be that of a person and not an automatic system.</span>

<span class="sd">            **Example**: `http://example.com/v1/structures?email_address=user@example.com`</span>

<span class="sd">        response_fields (str): A comma-delimited set of fields to be provided in the output.</span>
<span class="sd">            If provided, these fields MUST be returned along with the REQUIRED fields.</span>
<span class="sd">            Other OPTIONAL fields MUST NOT be returned when this parameter is present.</span>

<span class="sd">            **Example**: `http://example.com/v1/structures?response_fields=last_modified,nsites`</span>

<span class="sd">        include (str): A server MAY implement the JSON API concept of returning [compound documents](https://jsonapi.org/format/1.0/#document-compound-documents)</span>
<span class="sd">            by utilizing the `include` query parameter as specified by [JSON API 1.0](https://jsonapi.org/format/1.0/#fetching-includes).</span>

<span class="sd">            All related resource objects MUST be returned as part of an array value for the top-level `included` field,</span>
<span class="sd">            see the section JSON Response Schema: Common Fields.</span>

<span class="sd">            The value of `include` MUST be a comma-separated list of &quot;relationship paths&quot;, as defined in the [JSON API](https://jsonapi.org/format/1.0/#fetching-includes).</span>
<span class="sd">            If relationship paths are not supported, or a server is unable to identify a relationship path a `400 Bad Request` response MUST be made.</span>

<span class="sd">            The **default value** for `include` is `references`. This means `references` entries MUST always be included under the top-level field</span>
<span class="sd">            `included` as default, since a server assumes if `include` is not specified by a client in the request, it is still specified as `include=references`.</span>
<span class="sd">            Note, if a client explicitly specifies `include` and leaves out `references`, `references` resource objects MUST NOT be included under the top-level</span>
<span class="sd">            field `included`, as per the definition of `included`, see section JSON Response Schema: Common Fields.</span>

<span class="sd">            **Note**: A query with the parameter `include` set to the empty string means no related resource objects are to be returned under the top-level field `included`.</span>

<span class="sd">        api_hint (str): If the client provides the parameter, the value SHOULD have the format `vMAJOR` or `vMAJOR.MINOR`,</span>
<span class="sd">            where MAJOR is a major version and MINOR is a minor version of the API.</span>
<span class="sd">            For example, if a client appends `api_hint=v1.0` to the query string, the hint provided is for major version 1 and minor version 0.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">response_format</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The output format requested (see section Response Format).</span><span class="se">\n</span><span class="s2">Defaults to the format string &#39;json&#39;, which specifies the standard output format described in this specification.</span><span class="se">\n</span><span class="s2">Example: `http://example.com/v1/structures?response_format=xml`&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
        <span class="n">email_address</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="n">EmailStr</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;An email address of the user making the request.</span><span class="se">\n</span><span class="s2">The email SHOULD be that of a person and not an automatic system.</span><span class="se">\n</span><span class="s2">Example: `http://example.com/v1/structures?email_address=user@example.com`&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">response_fields</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A comma-delimited set of fields to be provided in the output.</span><span class="se">\n</span><span class="s2">If provided, these fields MUST be returned along with the REQUIRED fields.</span><span class="se">\n</span><span class="s2">Other OPTIONAL fields MUST NOT be returned when this parameter is present.</span><span class="se">\n</span><span class="s2">Example: `http://example.com/v1/structures?response_fields=last_modified,nsites`&quot;</span><span class="p">,</span>
                <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;([a-z_][a-z_0-9]*(,[a-z_][a-z_0-9]*)*)?&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">include</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s1">&#39;A server MAY implement the JSON API concept of returning [compound documents](https://jsonapi.org/format/1.0/#document-compound-documents) by utilizing the `include` query parameter as specified by [JSON API 1.0](https://jsonapi.org/format/1.0/#fetching-includes).</span><span class="se">\n\n</span><span class="s1">All related resource objects MUST be returned as part of an array value for the top-level `included` field, see the section JSON Response Schema: Common Fields.</span><span class="se">\n\n</span><span class="s1">The value of `include` MUST be a comma-separated list of &quot;relationship paths&quot;, as defined in the [JSON API](https://jsonapi.org/format/1.0/#fetching-includes).</span><span class="se">\n</span><span class="s1">If relationship paths are not supported, or a server is unable to identify a relationship path a `400 Bad Request` response MUST be made.</span><span class="se">\n\n</span><span class="s1">The **default value** for `include` is `references`.</span><span class="se">\n</span><span class="s1">This means `references` entries MUST always be included under the top-level field `included` as default, since a server assumes if `include` is not specified by a client in the request, it is still specified as `include=references`.</span><span class="se">\n</span><span class="s1">Note, if a client explicitly specifies `include` and leaves out `references`, `references` resource objects MUST NOT be included under the top-level field `included`, as per the definition of `included`, see section JSON Response Schema: Common Fields.</span><span class="se">\n\n</span><span class="s1">&gt; **Note**: A query with the parameter `include` set to the empty string means no related resource objects are to be returned under the top-level field `included`.&#39;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;references&quot;</span><span class="p">,</span>
        <span class="n">api_hint</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span>
            <span class="nb">str</span><span class="p">,</span>
            <span class="n">Query</span><span class="p">(</span>
                <span class="n">description</span><span class="o">=</span><span class="s2">&quot;If the client provides the parameter, the value SHOULD have the format `vMAJOR` or `vMAJOR.MINOR`, where MAJOR is a major version and MINOR is a minor version of the API. For example, if a client appends `api_hint=v1.0` to the query string, the hint provided is for major version 1 and minor version 0.&quot;</span><span class="p">,</span>
                <span class="n">pattern</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;(v[0-9]+(\.[0-9]+)?)?&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_format</span> <span class="o">=</span> <span class="n">response_format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email_address</span> <span class="o">=</span> <span class="n">email_address</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_fields</span> <span class="o">=</span> <span class="n">response_fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include</span> <span class="o">=</span> <span class="n">include</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_hint</span> <span class="o">=</span> <span class="n">api_hint</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">










<div class="doc doc-object doc-function">




<h3 id="optimade.server.entry_collections.mongo.SingleEntryQueryParams.check_params" class="doc doc-heading">
          <code class="highlight language-python"><span class="n">check_params</span><span class="p">(</span><span class="n">query_params</span><span class="p">)</span></code>

<a href="#optimade.server.entry_collections.mongo.SingleEntryQueryParams.check_params" class="headerlink" title="Permanent link">&para;</a></h3>


  <div class="doc doc-contents ">
  
      <p>This method checks whether all the query parameters that are specified
in the URL string are implemented in the relevant <code>*QueryParams</code> class.</p>
<p>This method handles four cases:</p>
<ul>
<li>If a query parameter is passed that is not defined in the relevant <code>*QueryParams</code> class,
  and it is not prefixed with a known provider prefix, then a <code>BadRequest</code> is raised.</li>
<li>If a query parameter is passed that is not defined in the relevant <code>*QueryParams</code> class,
  that is prefixed with a known provider prefix, then the parameter is silently ignored</li>
<li>If a query parameter is passed that is not defined in the relevant <code>*QueryParams</code> class,
  that is prefixed with an unknown provider prefix, then a <code>UnknownProviderQueryParameter</code>
  warning is emitted.</li>
<li>If a query parameter is passed that is on the <code>unsupported_params</code> list for the inherited
  class, then a <code>QueryParamNotUsed</code> warning is emitted.</li>
</ul>



  <p><strong>Parameters:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Type</th>
        <th>Description</th>
        <th>Default</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td><code>query_params</code></td>
          <td>
                <code><span title="collections.abc.Iterable">Iterable</span>[str]</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>An iterable of the request's string query parameters.</p>
            </div>
          </td>
          <td>
              <em>required</em>
          </td>
        </tr>
    </tbody>
  </table>



  <p><strong>Raises:</strong></p>
  <table>
    <thead>
      <tr>
        <th>Type</th>
        <th>Description</th>
      </tr>
    </thead>
    <tbody>
        <tr>
          <td>
                <code>`BadRequest`</code>
          </td>
          <td>
            <div class="doc-md-description">
              <p>if the query parameter was not found in the relevant class, or if it
does not have a valid prefix.</p>
            </div>
          </td>
        </tr>
    </tbody>
  </table>

          <details class="quote">
            <summary>Source code in <code>optimade/server/query_params.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">check_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query_params</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method checks whether all the query parameters that are specified</span>
<span class="sd">    in the URL string are implemented in the relevant `*QueryParams` class.</span>

<span class="sd">    This method handles four cases:</span>

<span class="sd">    * If a query parameter is passed that is not defined in the relevant `*QueryParams` class,</span>
<span class="sd">      and it is not prefixed with a known provider prefix, then a `BadRequest` is raised.</span>
<span class="sd">    * If a query parameter is passed that is not defined in the relevant `*QueryParams` class,</span>
<span class="sd">      that is prefixed with a known provider prefix, then the parameter is silently ignored</span>
<span class="sd">    * If a query parameter is passed that is not defined in the relevant `*QueryParams` class,</span>
<span class="sd">      that is prefixed with an unknown provider prefix, then a `UnknownProviderQueryParameter`</span>
<span class="sd">      warning is emitted.</span>
<span class="sd">    * If a query parameter is passed that is on the `unsupported_params` list for the inherited</span>
<span class="sd">      class, then a `QueryParamNotUsed` warning is emitted.</span>

<span class="sd">    Arguments:</span>
<span class="sd">        query_params: An iterable of the request&#39;s string query parameters.</span>

<span class="sd">    Raises:</span>
<span class="sd">        `BadRequest`: if the query parameter was not found in the relevant class, or if it</span>
<span class="sd">            does not have a valid prefix.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">CONFIG</span><span class="p">,</span> <span class="s2">&quot;validate_query_parameters&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unsupported_warnings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">query_params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unsupported_params</span><span class="p">:</span>
            <span class="n">unsupported_warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
            <span class="n">split_param</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">split_param</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">split_param</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">BaseResourceMapper</span><span class="o">.</span><span class="n">SUPPORTED_PREFIXES</span><span class="p">:</span>
                    <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">prefix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">BaseResourceMapper</span><span class="o">.</span><span class="n">KNOWN_PROVIDER_PREFIXES</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">warnings</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The query parameter(s) &#39;</span><span class="si">{</span><span class="n">warnings</span><span class="si">}</span><span class="s2">&#39; are unrecognised and have been ignored.&quot;</span><span class="p">,</span>
            <span class="n">UnknownProviderQueryParameter</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">unsupported_warnings</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The query parameter(s) &#39;</span><span class="si">{</span><span class="n">unsupported_warnings</span><span class="si">}</span><span class="s2">&#39; are not supported by this server and have been ignored.&quot;</span><span class="p">,</span>
            <span class="n">QueryParamNotUsed</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">errors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">BadRequest</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The query parameter(s) &#39;</span><span class="si">{</span><span class="n">errors</span><span class="si">}</span><span class="s2">&#39; are not recognised by this endpoint.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>
  </div>

</div>



  </div>

  </div>

</div>

<div class="doc doc-object doc-class">




<h2 id="optimade.server.entry_collections.mongo.SupportedBackend" class="doc doc-heading">
          <code>SupportedBackend</code>


<a href="#optimade.server.entry_collections.mongo.SupportedBackend" class="headerlink" title="Permanent link">&para;</a></h2>


  <div class="doc doc-contents ">
          <p class="doc doc-class-bases">
            Bases: <code><span title="enum.Enum">Enum</span></code></p>

  
      <p>Enumeration of supported database backends</p>
<ul>
<li><code>elastic</code>: <a href="https://www.elastic.co/">Elasticsearch</a>.</li>
<li><code>mongodb</code>: <a href="https://www.mongodb.com/">MongoDB</a>.</li>
<li><code>mongomock</code>: Also MongoDB, but instead of using the
    <a href="https://pymongo.readthedocs.io/"><code>pymongo</code></a> driver to connect to a live Mongo
    database instance, this will use the
    <a href="https://github.com/mongomock/mongomock"><code>mongomock</code></a> driver, creating an
    in-memory database, which is mainly used for testing.</li>
</ul>

            <details class="quote">
              <summary>Source code in <code>optimade/server/config.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">SupportedBackend</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumeration of supported database backends</span>

<span class="sd">    - `elastic`: [Elasticsearch](https://www.elastic.co/).</span>
<span class="sd">    - `mongodb`: [MongoDB](https://www.mongodb.com/).</span>
<span class="sd">    - `mongomock`: Also MongoDB, but instead of using the</span>
<span class="sd">        [`pymongo`](https://pymongo.readthedocs.io/) driver to connect to a live Mongo</span>
<span class="sd">        database instance, this will use the</span>
<span class="sd">        [`mongomock`](https://github.com/mongomock/mongomock) driver, creating an</span>
<span class="sd">        in-memory database, which is mainly used for testing.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ELASTIC</span> <span class="o">=</span> <span class="s2">&quot;elastic&quot;</span>
    <span class="n">MONGODB</span> <span class="o">=</span> <span class="s2">&quot;mongodb&quot;</span>
    <span class="n">MONGOMOCK</span> <span class="o">=</span> <span class="s2">&quot;mongomock&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>

  

  <div class="doc doc-children">











  </div>

  </div>

</div>




  </div>

  </div>

</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Built by the Materials-Consortia
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/Materials-Consortia" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": [], "search": "../../../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "stable", "provider": "mike"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.cd18aaf1.min.js"></script>
      
    
  </body>
</html>